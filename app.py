from flask import Flask, render_template, request, redirect, url_for, flash, jsonify
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import timedelta, datetime
import random, os
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt

from flask_cors import CORS

# --- ê¸°ë³¸ Flask ì„¤ì • ---
app = Flask(__name__)
CORS(app, supports_credentials=True)  # app ì •ì˜ í›„ CORS ì ìš©
app.config.update(
    SESSION_COOKIE_SAMESITE="None",
    SESSION_COOKIE_SECURE=True
)
app.secret_key = "secret-key"

# --- PostgreSQL ì—°ê²° ---
app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv("DATABASE_URL", "sqlite:///users.db")
app.config['SQLALCHEMY_ENGINE_OPTIONS'] = {"pool_pre_ping": True}
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(days=7)
db = SQLAlchemy(app)

# --- Flask-Login ì„¤ì • ---
login_manager = LoginManager()
login_manager.init_app(app)
login_manager.login_view = "login"

# --- ìœ ì € ëª¨ë¸ ---
class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(150), unique=True, nullable=False)
    password = db.Column(db.String(150), nullable=False)

# --- ëŒ€í™” ë¡œê·¸ ëª¨ë¸ ---
class ChatLog(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    role = db.Column(db.String(10))
    message = db.Column(db.Text)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)

with app.app_context():
    db.create_all()

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

# --- íšŒì›ê°€ì… ---
@app.route("/register", methods=["GET", "POST"])
def register():
    if request.method == "POST":
        username = request.form["username"]
        password = request.form["password"]
        hashed_pw = generate_password_hash(password)
        if User.query.filter_by(username=username).first():
            flash("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.")
            return redirect(url_for("register"))
        new_user = User(username=username, password=hashed_pw)
        db.session.add(new_user)
        db.session.commit()
        flash("íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.")
        return redirect(url_for("login"))
    return render_template("register.html")

# --- ë¡œê·¸ì¸ ---
@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username = request.form["username"]
        password = request.form["password"]
        user = User.query.filter_by(username=username).first()
        if user and check_password_hash(user.password, password):
            login_user(user)
            return redirect(url_for("chat_page"))
        else:
            flash("ë¡œê·¸ì¸ ì‹¤íŒ¨. ì•„ì´ë””ë‚˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
    return render_template("login.html")

# --- ë¡œê·¸ì•„ì›ƒ ---
@app.route("/logout")
@login_required
def logout():
    logout_user()
    flash("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect(url_for("login"))

# --- ì±„íŒ… í˜ì´ì§€ ---
@app.route("/")
@login_required
def chat_page():
    return render_template("index.html", username=current_user.username)

# --- ì±—ë´‡ ë¡œì§ ---
def classify_and_respond(user_input):
    mood_words = ["í˜ë“¤", "ìš°ìš¸", "ë¬´ê¸°ë ¥", "ê·€ì°®", "ì§œì¦", "ì£½ê³  ì‹¶", "ì˜ìš•ì—†", "ë¶ˆì•ˆ"]
    if any(w in user_input for w in mood_words):
        return random.choice([
            "ê·¸ë¬êµ¬ë‚˜... ìš”ì¦˜ ë§ˆìŒì´ ë§ì´ ë¬´ê±°ìš´ê°€ ë´.",
            "ê´œì°®ì•„, ê·¸ëŸ° ê¸°ë¶„ ëŠë¼ëŠ” ê±° ìì—°ìŠ¤ëŸ¬ì›Œ.",
            "í˜ë“¤ë©´ ì ì‹œ ì‰¬ì–´ê°€ë„ ê´œì°®ì•„."
        ])
    return random.choice([
        "ì‘, ê·¸ë˜!",
        "ê·¸ë ‡êµ¬ë‚˜~",
        "ìŒâ€¦ í¥ë¯¸ë¡­ë„¤.",
        "ì¢‹ì•„, ê³„ì† ì–˜ê¸°í•´ì¤˜!"
    ])

# --- ëŒ€í™” ì²˜ë¦¬ ---
@app.route("/chat", methods=["POST"])
@login_required
def chat():
    user_id = current_user.id
    message = request.form["message"]
    bot_reply = classify_and_respond(message)

    db.session.add(ChatLog(user_id=user_id, role="user", message=message))
    db.session.add(ChatLog(user_id=user_id, role="bot", message=bot_reply))
    db.session.commit()

    return jsonify({"response": bot_reply})


# --- 7ì¼ì¹˜ ê°ì • ë¶„ì„ + ê·¸ë˜í”„ ---
@app.route("/analyze")
@login_required
def analyze():
    user_id = current_user.id
    logs = ChatLog.query.filter(
        ChatLog.user_id == user_id,
        ChatLog.role == "user",
        ChatLog.timestamp >= datetime.utcnow() - timedelta(days=7)
    ).all()

    mood_keywords = ["í˜ë“¤", "ìš°ìš¸", "ë¬´ê¸°ë ¥", "ì§œì¦", "ê·€ì°®", "ì£½ê³  ì‹¶", "ì˜ìš•ì—†", "ë¶ˆì•ˆ"]
    daily_score = {}

    for log in logs:
        date = log.timestamp.date()
        score = sum(1 for kw in mood_keywords if kw in log.message)
        daily_score[date] = daily_score.get(date, 0) + score

    total_score = sum(daily_score.values())

    if total_score == 0:
        level = "ì •ìƒ ğŸ˜Š"
        advice = "ìµœê·¼ ëŒ€í™”ì—ì„œ ë¶€ì •ì ì¸ ê°ì •ì€ ê±°ì˜ ë³´ì´ì§€ ì•Šì•„ìš”. ì˜ ì§€ë‚´ê³  ìˆë„¤ìš”!"
    elif total_score <= 3:
        level = "ê²½ë„ ìš°ìš¸ ğŸ˜"
        advice = "ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆìŠ¤ë‚˜ í”¼ë¡œê°€ ëŠê»´ì ¸ìš”. ì¶©ë¶„íˆ ì‰¬ê³  ì¢‹ì•„í•˜ëŠ” ê±¸ í•´ë³´ì„¸ìš”."
    elif total_score <= 6:
        level = "ì¤‘ë“±ë„ ìš°ìš¸ ğŸ˜”"
        advice = "ê°ì •ì  í”¼ë¡œê°€ ëˆ„ì ëœ ê²ƒ ê°™ì•„ìš”. ê°€ê¹Œìš´ ì‚¬ëŒì—ê²Œ í„¸ì–´ë†“ëŠ” ê²ƒë„ ì¢‹ì•„ìš”."
    else:
        level = "ê³ ìœ„í—˜ ğŸ˜¢"
        advice = "ìµœê·¼ ëŒ€í™”ì—ì„œ ì‹¬í•œ ë¬´ê¸°ë ¥ê°ì´ ë³´ì—¬ìš”. ì „ë¬¸ ìƒë‹´ì‚¬ì—ê²Œ ë„ì›€ì„ ë°›ì•„ë³´ëŠ” ê²Œ ì¢‹ê² ì–´ìš”."

    if daily_score:
        dates = sorted(daily_score.keys())
        scores = [daily_score[d] for d in dates]
        plt.figure(figsize=(6, 3))
        plt.plot(dates, scores, marker='o', color='#2a6fb4')
        plt.title("ìµœê·¼ 7ì¼ ê°ì • í‚¤ì›Œë“œ ë³€í™”")
        plt.xlabel("ë‚ ì§œ")
        plt.ylabel("ê°ì • ì ìˆ˜")
        plt.grid(True, alpha=0.3)
        plt.tight_layout()

        os.makedirs("static", exist_ok=True)
        graph_path = os.path.join("static", "mood_graph.png")
        plt.savefig(graph_path)
        plt.close()
    else:
        graph_path = None

    return render_template("result.html",
                           username=current_user.username,
                           score=total_score,
                           level=level,
                           advice=advice,
                           graph=graph_path)

if __name__ == "__main__":
    app.run(debug=True)

# === ì±—ë´‡ ë°ì´í„° (ì½”ë©ì—ì„œ ì“°ë˜ ê±°) ===
import random
# === ì¼ìƒ ëŒ€í™” í‚¤ì›Œë“œ ===ì—¬ê¸°ë³´ë‹¤ëŠ” ë’¤ì— categories ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”
daily_categories = {
    "ë¬´ë§¥ë½ ì• ë§¤í•œ ê²ƒë“¤": ["ì—ë°”ì•¼"],
    "ì¸ì‚¬/ìê¸°ì†Œê°œ": [
        "ì•ˆë…•", "ì•ˆë…•í•˜ì„¸ìš”", "í•˜ì´", "í—¬ë¡œ", "ë°˜ê°€ì›Œ", "ì˜ ì§€ëƒˆì–´",
        "ëˆ„êµ¬", "ì •ì²´", "ì±—ë´‡", "ë„ˆ ë­ì•¼", "ì´ë¦„", "ì†Œê°œ", "ìê¸°ì†Œê°œ"
    ],
    "ê°ì‚¬/ì¹­ì°¬": [
        "ê³ ë§ˆì›Œ", "ê°ì‚¬", "ë•ë¶„", "ë•¡í", "ì‚¬ë‘í•´", "ì¢‹ì•„í•´",
        "ëŒ€ë‹¨í•´", "ë©‹ì§€ë‹¤", "êµ¿", "ì˜í–ˆì–´", "ìµœê³ ", "ëŒ€ë°•"
    ],
    "ë†€ëŒ/ê°íƒ„": [
        "í—", "ì„¸ìƒì—", "ì§„ì§œ", "ì™€", "ìš°ì™€", "í—‰", "ëŒ€ë°•", "ì©ë‹¤", "ë¯¸ì³¤ë‹¤", "ì†Œë¦„", "ë¯¸ì¹œ", "ã…ã…Š", "ì‰£", "í—", "ì—¥"
    ],
    "ìš•ì„¤/ë¶€ì •": [
        "ì§œì¦", "ë¹¡ì³", "ì—´ë°›ì•„", "í™”ë‚˜", "ê°œë¹¡ì³", "ì”¨ë°œ", "ì  ì¥", "ë§í–ˆë‹¤",
        "ê°œë…¸ë‹µ", "ê°œê°™", "ë³‘ì‹ ", "ë©ì²­", "ì¢†", "êº¼ì ¸"
    ],
    "ë°¥/ìŒì‹": [
        "ë°¥", "ì‹ì‚¬", "ë°¥ë§›", "ì…ë§›", "ë°°ê³ íŒŒ", "ë°°ë¶ˆëŸ¬", "ë¨¹ê¸° ì‹«ì–´", "ê³¼ì‹", "í­ì‹",
        "ë¼ë©´", "ì§œíŒŒê²Œí‹°", "ì‹ ë¼ë©´", "ì»µë¼ë©´", "ìš°ë™", "êµ­ìˆ˜", "ì¹¼êµ­ìˆ˜",
        "í”¼ì", "ì¹˜í‚¨", "í–„ë²„ê±°", "ìƒŒë“œìœ„ì¹˜", "ê¹€ë°¥", "ë–¡ë³¶ì´", "ìˆœëŒ€", "ì˜¤ë…", "íŠ€ê¹€",
        "íŒŒìŠ¤íƒ€", "ìŠ¤í…Œì´í¬", "ëˆê¹ŒìŠ¤", "ì´ˆë°¥", "íšŒ", "ì‚¼ê²¹ì‚´", "ë¶ˆê³ ê¸°",
        "ê³¼ì", "ì¿ í‚¤", "ë¹µ", "ì¼€ì´í¬", "ì´ˆì½œë¦¿", "ì•„ì´ìŠ¤í¬ë¦¼", "ë¹™ìˆ˜", "ì ¤ë¦¬",
        "ê°„ì‹", "ì•¼ì‹", "ë¶„ì‹", "ë§ˆë¼íƒ•", "ê¹€ì¹˜ì°Œê°œ", "ëœì¥ì°Œê°œ", "êµ­", "ì°Œê°œ"
    ],
    "ìŒë£Œ/ë””ì €íŠ¸": [
        "ì»¤í”¼", "ì•„ë©”ë¦¬ì¹´ë…¸", "ë¼ë–¼", "ì¹´í‘¸ì¹˜ë…¸", "ëª¨ì¹´", "ì½œë“œë¸Œë£¨", "ì—ìŠ¤í”„ë ˆì†Œ",
        "ë…¹ì°¨", "í™ì°¨", "ë°€í¬í‹°", "ë²„ë¸”í‹°", "ì½”ì½”ì•„", "í•«ì´ˆì½”", "ì£¼ìŠ¤", "ìŠ¤ë¬´ë””",
        "ì‰ì´í¬", "íƒ„ì‚°", "ì½œë¼", "ì‚¬ì´ë‹¤", "í™˜íƒ€", "ë§¥ì£¼", "ì†Œì£¼", "ë§‰ê±¸ë¦¬", "ì™€ì¸",
        "ì¹µí…Œì¼", "ë ˆëª¬ì—ì´ë“œ", "ì²­í¬ë„ì—ì´ë“œ"
    ],
    "ë‚ ì”¨/ê³„ì ˆ": [
        "ë‚ ì”¨", "ë§‘ì•„", "íë ¤", "ë¹„", "ëˆˆ", "ì¥ë§ˆ", "ì†Œë‚˜ê¸°", "íƒœí’", "ë²ˆê°œ", "ì²œë‘¥",
        "ë¬´ì§€ê°œ", "ì•ˆê°œ", "ë¯¸ì„¸ë¨¼ì§€", "í™©ì‚¬", "ë”ì›Œ", "ì¶”ì›Œ", "ìŒ€ìŒ€", "ì„œëŠ˜", "ë´„",
        "ì—¬ë¦„", "ê°€ì„", "ê²¨ìš¸", "ê½ƒ", "ë²šê½ƒ", "ë‹¨í’", "ë‚™ì—½", "í–‡ë¹›", "í–‡ì‚´", "ë°”ëŒ"
    ],
    "í•™êµ/ê³µë¶€": [
        "í•™êµ", "í•™ì›", "ê³µë¶€", "ì‹œí—˜", "ëª¨ì˜ê³ ì‚¬", "ìˆ˜ëŠ¥", "ì¤‘ê°„ê³ ì‚¬", "ê¸°ë§ê³ ì‚¬",
        "ìˆ˜ì—…", "ê³¼ì œ", "ìˆ™ì œ", "ì„±ì ", "ë“±ê¸‰", "í•™ì ", "ë ˆí¬íŠ¸", "íŒ€í”Œ",
        "êµì‹¤", "êµê³¼ì„œ", "ë¬¸ì œì§‘", "í•„ê¸°", "ë…¸íŠ¸í•„ê¸°", "ìˆ˜í•™", "ì˜ì–´", "êµ­ì–´",
        "ê³¼í•™", "ì—­ì‚¬", "ì‚¬íšŒ", "í•œêµ­ì‚¬", "ì²´ìœ¡", "ìŒì•…", "ë¯¸ìˆ ", "ì„ ìƒë‹˜", "ìŒ¤"
    ],
    "ì·¨ë¯¸/ì—¬ê°€": [
        "ê²Œì„", "ë¡¤", "ì˜¤ë²„ì›Œì¹˜", "ë°œë¡œë€íŠ¸", "í”¼íŒŒ", "ë°°ê·¸", "ë§ˆì¸í¬ë˜í”„íŠ¸",
        "ìŒì•…", "ë…¸ë˜", "ê°€ìˆ˜", "ì•„ì´ëŒ", "ì½˜ì„œíŠ¸", "ì˜í™”", "ë“œë¼ë§ˆ", "ë„·í”Œë¦­ìŠ¤",
        "ìœ íŠœë¸Œ", "í‹±í†¡", "ì±…", "ì†Œì„¤", "ì›¹íˆ°", "ë§Œí™”", "ìš´ë™", "í—¬ìŠ¤", "ëŸ¬ë‹",
        "ì‚°ì±…", "ë“±ì‚°", "ì¶•êµ¬", "ë†êµ¬", "ë°°êµ¬", "ì•¼êµ¬", "ìˆ˜ì˜", "ìš”ê°€", "í•„ë¼í…ŒìŠ¤",
        "ì—¬í–‰", "êµ­ë‚´ì—¬í–‰", "í•´ì™¸ì—¬í–‰", "ìº í•‘", "í”¼í¬ë‹‰", "ì‡¼í•‘", "íŒ¨ì…˜", "ì˜·", "ì½”ë””"
    ],
    "ê´€ê³„/ìƒí™œ": [
        "ì¹œêµ¬", "ë² í”„", "ë‹¨ì§", "ì„ ë°°", "í›„ë°°", "ë™ê¸°",
        "ê°€ì¡±", "ì—„ë§ˆ", "ì•„ë¹ ", "í˜•", "ëˆ„ë‚˜", "ë™ìƒ", "ì–¸ë‹ˆ",
        "ì—°ì• ", "ì‚¬ë‘", "ë‚¨ì¹œ", "ì—¬ì¹œ", "ì¸", "ì§ì‚¬ë‘", "ì»¤í”Œ", "ë°ì´íŠ¸",
        "ì•½ì†", "ëª¨ì„", "ë™ì•„ë¦¬", "ìŠ¤í„°ë””", "ìƒì¼", "íŒŒí‹°", "ì¶•í•˜", "ê¸°ë…ì¼", "ì„ ë¬¼"
    ]
}

daily_responses = {
    "ë¬´ë§¥ë½ ì• ë§¤í•œ ê²ƒë“¤": [ ""],
    "ë°¥/ìŒì‹": [
        "ì˜¤ëŠ˜ ë­ ë¨¹ì—ˆì–´?", "ë°¥ì€ ë¨¹ì—ˆì–´?", "ìš”ì¦˜ ìì£¼ ë¨¹ëŠ” ìŒì‹ ìˆì–´?", "ì•¼ì‹ ìì£¼ ë¨¹ì–´?",
        "ë¼ë©´ ì¢‹ì•„í•´?", "ì¹˜í‚¨ì€ ì–¸ì œ ë¨¹ì–´ë„ ì˜³ì§€ ğŸ”", "í”¼ìë‘ ì¹˜í‚¨ ì¤‘ì— ë­ê°€ ë” ì¢‹ì•„?",
        "ë°¥ ë¨¹ê³  ë‚˜ë©´ ê¸°ë¶„ì´ ì–´ë•Œ?", "ìš”ì¦˜ ì…ë§› ë‹¹ê¸°ëŠ” ìŒì‹ ìˆì–´?", "ë°¥ì€ í˜¼ì ë¨¹ëŠ” ê²Œ ì¢‹ì•„?"
    ],
    "ìŒë£Œ/ë””ì €íŠ¸": [
        "ì»¤í”¼ ìì£¼ ë§ˆì…”?", "ìš”ì¦˜ì€ ë¬´ìŠ¨ ìŒë£Œê°€ ì œì¼ ì¢‹ì•„?", "ë‹¨ ê±° ì¢‹ì•„í•´? ğŸ«",
        "ë²„ë¸”í‹° ì¢‹ì•„í•´?", "ì—¬ë¦„ì—” ë¹™ìˆ˜ì§€ ğŸ§", "ì½œë¼íŒŒì•¼ ì‚¬ì´ë‹¤íŒŒì•¼?", "ì°¨ ë§ˆì‹œëŠ” ê±° ì¢‹ì•„í•´?",
        "ìš”ì¦˜ ë””ì €íŠ¸ ì¹´í˜ ê°€ë´¤ì–´?", "ì»¤í”¼ëŠ” ì•„ì´ìŠ¤? í•«?", "ì•„ì´ìŠ¤í¬ë¦¼ ë¬´ìŠ¨ ë§› ì¢‹ì•„í•´?"
    ],
    "ë‚ ì”¨/ê³„ì ˆ": [
        "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë• ì–´?", "ë¹„ ì˜¤ëŠ” ë‚  ê¸°ë¶„ ë‹¬ë¼ì ¸?", "ëˆˆ ì˜¤ëŠ” ê±° ì¢‹ì•„í•´?",
        "ì—¬ë¦„ì´ë‘ ê²¨ìš¸ ì¤‘ì— ë­ê°€ ë” ì¢‹ì•„?", "ìš”ì¦˜ ì¢€ ìŒ€ìŒ€í•˜ì§€ ì•Šì•„?",
        "í–‡ì‚´ ì¢‹ì€ ë‚ ì—” ë­ í•˜ê³  ì‹¶ì–´?", "ë°”ëŒ ë¶€ëŠ” ë‚ ì—” ê¸°ë¶„ì´ ì–´ë•Œ?",
        "ì¥ë§ˆì² ì€ í˜ë“¤ì§€ ì•Šì•„?", "ê°€ì„ì—” ë‹¨í’ êµ¬ê²½ ê°€ê³  ì‹¶ì§€?", "ë´„ì—” ë²šê½ƒ ë³´ëŸ¬ ê°€ë´¤ì–´?"
    ],
    "í•™êµ/ê³µë¶€": [
        "ì˜¤ëŠ˜ ìˆ˜ì—… ì–´ë• ì–´?", "ê³¼ì œëŠ” ë‹¤ í–ˆì–´?", "ì‹œí—˜ê¸°ê°„ í˜ë“¤ì§€?", "ê³µë¶€í•  ë•Œ ì§‘ì¤‘ ì˜ ë¼?",
        "ì‹«ì–´í•˜ëŠ” ê³¼ëª© ìˆì–´?", "ì¢‹ì•„í•˜ëŠ” ê³¼ëª©ì€ ë­ì•¼?", "í•™êµì—ì„œ ì œì¼ ì¬ë°ŒëŠ” ì‹œê°„ì€?",
        "ì¹œí•œ ì¹œêµ¬ë‘ ê°™ì€ ë°˜ì´ì•¼?", "ìˆ™ì œ ë°€ë¦° ê±° ìˆì§€ ì•Šì•„?ã…‹ã…‹", "ìš”ì¦˜ í•™ì› ìì£¼ ê°€?"
    ],
    "ì·¨ë¯¸/ì—¬ê°€": [
        "ìš”ì¦˜ ë¬´ìŠ¨ ê²Œì„ í•´?", "ìµœê·¼ì— ë³¸ ì˜í™” ìˆì–´?", "ë“œë¼ë§ˆ ë³´ëŠ” ê±° ì¢‹ì•„í•´?",
        "ìœ íŠœë¸Œ ìì£¼ ë´?", "ì¢‹ì•„í•˜ëŠ” ë…¸ë˜ ìˆì–´?", "ì•„ì´ëŒ ëˆ„êµ¬ ì¢‹ì•„í•´?",
        "ìš´ë™ ìì£¼ í•´?", "ì—¬í–‰ ê°€ê³  ì‹¶ì€ ê³³ ìˆì–´?", "ìš”ì¦˜ ë¹ ì ¸ ìˆëŠ” ì·¨ë¯¸ ìˆì–´?",
        "ì›¹íˆ° ë³´ëŠ” ê±° ì¢‹ì•„í•´?"
    ],
    "ê´€ê³„/ìƒí™œ": [
        "ì¹œêµ¬ë“¤ì´ë‘ ë­ í•˜ê³  ë†€ì•„?", "ê°€ì¡±ì´ë‘ ì§€ë‚¼ ë•Œ ì–´ë•Œ?", "ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒì´ ìˆì–´?",
        "ìš”ì¦˜ ì‚¬ëŒ ë§Œë‚˜ëŠ” ê±° ì¦ê±°ì›Œ?", "ì£¼ë§ì— ì•½ì† ìˆì–´?", "ì¹œí•œ ì¹œêµ¬ë‘ ìì£¼ ì—°ë½í•´?",
        "ìƒì¼íŒŒí‹° í•œ ì  ìˆì–´?", "ì—°ì• í•´ë³¸ ì  ìˆì–´?", "ê°€ì¡±ì´ë‘ ê°™ì´ ì‹œê°„ ë³´ë‚´ëŠ” ê±° ì¢‹ì•„í•´?",
        "ìš”ì¦˜ ì™¸ë¡­ë‹¤ê³  ëŠë‚€ ì  ìˆì–´?"
    ],
    "ì¸ì‚¬/ìê¸°ì†Œê°œ": [
        "ì•ˆë…•! ë§Œë‚˜ì„œ ë°˜ê°€ì›Œ ğŸ˜€",
        "í•˜ì´~ ì˜¤ëŠ˜ ê¸°ë¶„ ì–´ë•Œ?",
        "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ê·¸ëƒ¥ ëŒ€í™”í•˜ëŠ” ì±—ë´‡ì´ì—ìš” ğŸ¤–",
        "ë‚˜ëŠ” ë„¤ ì–˜ê¸° ë“¤ì–´ì£¼ëŠ” AIì•¼.",
        "ë‚˜? ë„ˆë‘ ì–˜ê¸°í•˜ë ¤ê³  ë§Œë“¤ì–´ì§„ ì±—ë´‡ì´ì•¼!",
        "ë‚´ ì´ë¦„ì€ ë¼ë¦¬ì•¼, ë„¤ ì–˜ê¸° ì˜ ë“¤ì–´ì¤„ê²Œ!",
        "ë‚œ ì±—ë´‡ì¸ë°, ì¹œêµ¬ì²˜ëŸ¼ ì–˜ê¸°í•´ë„ ë¼."
    ],
    "ê°ì‚¬/ì¹­ì°¬": [
        "ë‚˜ë„ ê³ ë§ˆì›Œ ğŸ™",
        "ê·¸ë ‡ê²Œ ë§í•´ì£¼ë‹ˆê¹Œ ê¸°ë¶„ ì¢‹ë‹¤ ğŸ˜€",
        "ë„ˆ ì§„ì§œ ì°©í•˜ë‹¤!",
        "ì¹­ì°¬ ê³ ë§ˆì›Œ ã…ã…",
        "ë‚˜ë„ ë„ˆ ë©‹ì§€ë‹¤ê³  ìƒê°í•´ ğŸ‘",
        "ëŒ€ë‹¨í•˜ë‹¤~",
        "ë„ˆ ìµœê³ ì•¼!"
    ],
    "ë†€ëŒ/ê°íƒ„": [
        "í— ëŒ€ë°•â€¦",
        "ì§„ì§œ? ã„¹ã…‡?",
        "ì™€â€¦ ê·¸ê±´ ì‹ ê¸°í•˜ë‹¤!",
        "ì†Œë¦„ë‹ì•„ ğŸ˜²",
        "ìš°ì™€~ ë©‹ì§€ë‹¤!",
        "í—‰ ëŒ€ë‹¨í•´!",
        "ì™€ ë¯¸ì³¤ë‹¤ã…‹ã…‹"
    ],
    "ìš•ì„¤/ë¶€ì •": [
        "ë§ì´ í™”ë‚œ ê²ƒ ê°™ì•„ ğŸ˜¢",
        "ê·¸ëŸ´ ë•Œë„ ìˆì§€â€¦",
        "ê¸°ë¶„ í’€ë¦´ ë•Œê¹Œì§€ ì–˜ê¸°í•´ë„ ë¼.",
        "ì†ìƒí–ˆê² ë‹¤.",
        "ëˆ„êµ¬ë‚˜ ì—´ë°›ì„ ë•ŒëŠ” ìˆì–´.",
        "ê´œì°®ì•„, ì²œì²œíˆ ì–˜ê¸°í•´."
    ]
}

# ì¹´í…Œê³ ë¦¬ë³„ í‚¤ì›Œë“œ ì‚¬ì „ #ì—¬ê¸°ë¶€ë¶„ì„ ìˆ˜ì •í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤
categories = {
    "ê¸°ë¶„": [
        # ê¸°ë³¸
        "ê¸°ë¶„", "ë¬´ê¸°ë ¥", "ì§œì¦", "ë¶ˆì¾Œ", "í¥ë¯¸ì—†", "ì¬ë¯¸ì—†", "í˜ë“¤", "ê·€ì°®",
        # í™•ì¥
        "ìš°ìš¸","ê·¸ëŸ­ì €ëŸ­", "ì¹¨ìš¸", "í—ˆë¬´", "ì˜ìš•ì—†", "ì§œì¦ë‚˜", "í™”ë‚˜", "ì—´ë°›", "ë¹¡ì³",
        "ì‹¬ì‹¬", "ë©í•¨", "ë¬´ê°€ì¹˜", "ìŠ¬í¼", "ë¶ˆí–‰", "ì§€ì¹¨", "ê¶Œíƒœ", "ì§œì¦ë‚¨",
        "ì§œì¦ì´ë‚¨", "ì†ìƒ", "ìš°ìš¸ê°", "ì˜ë¯¸ì—†", "ë¬´ë ¥ê°", "í”¼ê³¤", "ë¬´ê°ì •",
        "ê³µí—ˆ", "í—ˆíƒˆ", "ë¬´ê¸°ë ¥í•¨", "ê°ì •ì—†", "ì§œì¦ë‚¨", "ë¶ˆì•ˆ", "ë§ˆìŒì´ ë¬´ê±°ì›Œ"
    ],
    "ì ": [
        # ê¸°ë³¸
        "ì ", "ë¶ˆë©´", "ì¡¸ë ¤", "í”¼ê³¤", "ì„¤ì³", "ëª»ì", "ê¹Šì´", "ëˆˆì´ ë¬´ê±°ì›Œ",
        "ëˆ„ì›Œ", "ë°¤ìƒ˜", "ë°¤ìƒˆ", "ëª»ì¤", "ê¹¨", "ì¡¸ìŒ",
        # í™•ì¥
        "ë¶ˆë©´ì¦", "ë’¤ì²™", "ë’¤ì²™ì„", "ìˆ™ë©´", "ë‹¨ì ", "ì ì´ ì•ˆì™€", "ì ì´ ì•ˆì˜´",
        "ìˆ˜ë©´", "ìˆ˜ë©´ì¥ì• ", "ê¹œë¹¡", "ë¹„ëª½ì‚¬ëª½", "ì íˆ¬ì •", "ê¹Šì€ì ", "ì„ ì ",
        "ê¿ˆë§ìŒ", "ì•…ëª½", "ìë‹¤ê¹¸", "ì ê¹¸", "ìë„í”¼ê³¤", "ì•„ì¹¨ì— í˜ë“¦",
        "ëŠ¦ê²Œì ", "ìƒˆë²½ê¹Œì§€", "ì•„ì˜ˆ ëª»ì ", "ì•„ì˜ˆëª»ì "
    ],
    "ë°¥": [
        # ê¸°ë³¸
        "ë°¥", "í­ì‹", "êµ¶", "í—ˆê¸°", "ë°°ê³ í”„", "ë°¥ë§›", "ì…ë§›", "í† í–ˆ", "ê°„ì‹",
        "ë¼ë©´", "í”¼ì", "ì¹˜í‚¨", "í–„ë²„ê±°", "ë°°ë¶€ë¥¸ë°ë„", "ê³¼ì‹", "ë¨¹ê¸° ì‹«ì–´",
        # í™•ì¥
        "ê³¼ì", "ë¹µ", "ë‹¨ê±°", "ë‹¨ê±°ë•¡ê²¨", "ë‹¨ìŒì‹", "êµ°ê²ƒì§ˆ", "ìê·¹ì  ìŒì‹",
        "ë‹¬ë‹¬", "ì§œê²Œ", "ë§¤ìš´ê±°", "ë–¡ë³¶ì´", "ê¹€ë°¥", "ìƒŒë“œìœ„ì¹˜", "ë¶„ì‹",
        "ë‹¨ê±°ë§Œ", "í­ì‹ì¦", "ê±°ì‹", "ì‹ìš•ì—†", "ì‹ìš•ë¶€ì§„", "ì•„ë¬´ê²ƒë„ ì•ˆë¨¹ìŒ",
        "ë°°ê³ í”ˆë° ë¨¹ê¸°ì‹«", "ì…ë§›ì—†ìŒ", "ê³„ì†ë¨¹ìŒ"
    ],
    "ì§‘ì¤‘": [
        # ê¸°ë³¸
        "ì§‘ì¤‘", "ê¸€ì", "ìˆ˜ì—…", "ì´í•´", "ë¶ˆì•ˆ",
        # í™•ì¥
        "ë©ë•Œë¦¼", "ì£¼ì˜ì‚°ë§Œ", "ì‚°ë§Œ", "ì§‘ì¤‘ì•ˆë¨", "ì •ì‹ ì—†ìŒ", "ë©í•¨",
        "ê³µë¶€ì•ˆë¨", "ë”´ì§“", "ìê¾¸ì‚°ë§Œ", "ëª°ì…ì•ˆë¨", "ì§‘ì¤‘ë ¥ë–¨ì–´ì§",
        "ì‚°ë§Œí•´ì§", "ì£¼ìœ„ì‚°ë§Œ", "ì§‘ì¤‘ëª»í•¨", "ì§‘ì¤‘ë¶€ì¡±", "ê³µë¶€ì§‘ì¤‘ì•ˆë¨"
    ],
    "ì‚¬ê³ ì¸ì§€": [
        # ê¸°ë³¸
        "ìƒê°", "ë©í•´", "ë¬´ì˜ë¯¸", "ë§í–ˆ", "ë¹„ê´€", "ì“°ë ˆê¸°", "ì£½ê³  ì‹¶", "ì´ˆì¡°",
        "ë¯¸ì›Œ", "ì‹«ì–´", "ë¶€ì •ì ", "í¬ë§ì—†", "ì ˆë§", "ì“¸ëª¨ì—†", "ê³µí—ˆ",
        # í™•ì¥
        "ìì‚´", "ì£½ê³ ì‹¶ë‹¤", "ì‚´ê¸°ì‹«ë‹¤", "ëë‚´ê³ ì‹¶ë‹¤", "ì—†ì–´ì§€ê³ ì‹¶ë‹¤",
        "ë‚´íƒ“", "ë‚˜ëŠ”ë³„ë¡œ", "ë‚˜ëŠ”ëª»ë‚¨", "ë‚˜ëŠ”ì“¸ëª¨ì—†ë‹¤", "ë‚˜ëŠ”ê°€ì¹˜ì—†ë‹¤",
        "ì•„ë¬´ìƒê°ì—†ìŒ", "ìƒê°í•˜ê¸°ì‹«ë‹¤", "ë¹„ê´€ì ", "ìŠ¬í”„ë‹¤", "ë¯¸ë˜ì—†ë‹¤",
        "í¬ë§ì—†ë‹¤", "ë‚˜ì‚¬ë¼ì§€ê³ ì‹¶ë‹¤", "ë‚´ì˜ëª»", "ë‹¤ë§í•¨", "í—›ë¨", "ì˜ë¯¸ì—†ìŒ"
    ],
    "ìì œë ¥": [
        # ê¸°ë³¸
        "ì¶©ë™", "ë¶€ìˆ˜", "ë•Œë¦¬ê³ ", "í™”", "ìˆ ",
        # í™•ì¥
        "ìš±í•¨", "ì°¸ê¸°í˜ë“¦", "ì¡°ì ˆì•ˆë¨", "ë¶„ë…¸", "íŒ¨ê³ ì‹¶ë‹¤", "ë¶€ìˆ˜ê³ ì‹¶ë‹¤",
        "ë°•ì‚´ë‚´ê³ ì‹¶ë‹¤", "ë•Œë¦¬ê³ ì‹¶ë‹¤", "ìš•í•˜ê³ ì‹¶ë‹¤", "ì†Œë¦¬ì§€ë¥´ê³ ì‹¶ë‹¤",
        "ê°ì •ì¡°ì ˆì•ˆë¨", "ë¶„ë…¸ì¡°ì ˆì•ˆë¨", "ì£¼ì²´ì•ˆë¨", "ìš•ì„¤", "í™”í’€ì´"
    ],
    "ì‹ ì²´": [
        # ê¸°ë³¸
        "ë¨¸ë¦¬", "ë‘í†µ", "ë³µí†µ", "ì†Œí™”", "ëª¸ë¬´ê²Œ", "ìˆ¨", "ë°°ì•„íŒŒ", "í† í• ",
        "ì†Œí™”ë¶ˆëŸ‰", "í”¼ê³¤", "í˜ë“¤ì–´", "ì–´ì§€ëŸ¬", "ë¬´ê±°ì›Œ", "ê°€ë¹ ", "ì²´ë ¥",
        # í™•ì¥
        "ì†ì•„í””", "ìœ„ê²½ë ¨", "ìœ„í†µ", "ì†ì“°ë¦¼", "ì²´í•¨", "ë”ë¶€ë£©", "ë‹µë‹µ",
        "ì†Œí™”ì•ˆë¨", "ì†ë¶ˆí¸", "êµ¬í† ", "í† í•¨", "ë©”ìŠ¤êº¼ì›€", "í˜„ê¸°ì¦",
        "ê¸°ì ˆí• ê²ƒê°™ì•„", "í˜ë¹ ì§", "í”¼ê³¤í•¨", "ë¬´ê¸°ë ¥í•¨", "ìˆ¨ë§‰í˜", "ìˆ¨ì•ˆì‰¬ì–´ì§"
    ],
    "ê´€ê³„": [
        # ê¸°ë³¸
        "ì¹œêµ¬", "ê°€ì¡±", "ì‹«ì–´", "ê´€ì‹¬", "ìˆ˜ê·¼", "ê·€ì°®",
        # í™•ì¥
        "ì™¸ë¡œì›€", "ì™•ë”°", "ë”°ëŒë¦¼", "í˜¼ì", "ê°™ì´ë†€ê¸°ì‹«ì–´", "ëŒ€í™”í•˜ê¸°ì‹«ì–´",
        "ë§í•˜ê¸°ì‹«ì–´", "ì¸ê°„ê´€ê³„í˜ë“¦", "ì‚¬ëŒí”¼ê³¤", "ì‚¬ëŒì‹«ì–´", "ì‚¬ëŒê·€ì°®",
        "ë‹¤ë“¤ë‚ ì‹«ì–´", "ë¬´ì‹œ", "ì°¨ë³„", "ë”°ëŒë ¤ì§", "í˜¼ììˆê³ ì‹¶ë‹¤", "ë‚˜í˜¼ì",
        "ê´€ê³„ëŠê³ ì‹¶ë‹¤", "ì‚¬ëŒì‹«ë‹¤", "ì‚¬íšŒë¶ˆì•ˆ", "ëŒ€ì¸ë¶ˆì•ˆ"
    ]
}


# ì¹´í…Œê³ ë¦¬ë³„ ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ #ì—¬ê¸°ë¶€ë¶„ì„ ìˆ˜ì •í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤
questions = {
    "ê¸°ë¶„": [
        "ìš”ì¦˜ í•˜ë£¨í•˜ë£¨ë¥¼ ë³´ë‚¼ ë•Œ ê°€ì¥ ë§ì´ ëŠë¼ëŠ” ê°ì •ì€ ë­ì•¼?",
        "ìµœê·¼ì— ì›ƒì—ˆë˜ ìˆœê°„ì´ë‚˜ ì¦ê±°ì› ë˜ ê²½í—˜ì´ ìˆì—ˆì–´?",
        "ìš”ì¦˜ ìì£¼ ë– ì˜¤ë¥´ëŠ” ìƒê°ì´ë‚˜ ê°ì •ì´ ìˆë‹¤ë©´ ì–´ë–¤ ê±°ì•¼?",
        "ë§ˆìŒì´ ë¬´ê²ê²Œ ëŠê»´ì§ˆ ë•ŒëŠ” ë³´í†µ ì–´ë–¤ ìƒí™©ì´ ë§ì•„?"
    ],
    "ì ": [
        "ìš”ì¦˜ ì ì€ ì˜ ì?",
        "ë°¤ì— ì ë“¤ê¸° ì–´ë ¤ìš¸ ë•Œ ë³´í†µ ë­í•´?",
        "ì ì„ ì˜ ì¤ì„ ë•Œë‘ ëª» ì¤ì„ ë•Œ í•˜ë£¨ê°€ ì–´ë–»ê²Œ ë‹¬ë¼?",
        "ìì£¼ í”¼ê³¤í•˜ë‹¤ ëŠë¼ëŠ” ìˆœê°„ì´ ìˆì–´?"
    ],
    "ë°¥": [
        "ë°¥ ë¨¹ëŠ” ê²Œ ìš”ì¦˜ì€ ì–´ë•Œ?",
        "ì‹ì‚¬ íŒ¨í„´ì´ ë‹¬ë¼ì§„ ê±¸ ëŠë‚€ ì  ìˆì–´?",
        "ë°¥ ë¨¹ê³  ë‚˜ë©´ ë³´í†µ ê¸°ë¶„ì´ ì–´ë•Œ?",
        "ìš”ì¦˜ ìì£¼ ë¨¹ê²Œ ë˜ëŠ” ìŒì‹ì´ ìˆì–´?"
    ],
    "ì§‘ì¤‘": [
        "ê³µë¶€í•  ë•Œ ì§‘ì¤‘ì´ ì˜ ì•ˆ ë  ë•Œê°€ ë§ì•„?",
        "ì§‘ì¤‘ì„ ì¡°ê¸ˆì´ë¼ë„ ìœ ì§€í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆì„ê¹Œ?",
        "ìˆ˜ì—…ì´ ì˜ ì•ˆ ë“¤ì–´ì˜¬ ë•Œ ë„ˆëŠ” ì–´ë–»ê²Œ í•´?",
        "ì§‘ì¤‘í•˜ê¸° í˜ë“¤ ë•Œ ê¸°ë¶„ì€ ì–´ë•Œ?"
    ],
    "ì‚¬ê³ ì¸ì§€": [
        "ìš”ì¦˜ ê°€ì¥ ìì£¼ ë“œëŠ” ìƒê°ì€ ë­ì•¼?",
        "ë§ˆìŒì´ ë¹„ê´€ì ìœ¼ë¡œ íë¥¼ ë•Œ ë³´í†µ ì–´ë–¤ ìƒí™©ì´ ë§ì•„?",
        "ìƒê°ì´ ë©ˆì¶”ì§€ ì•Šì„ ë•Œ ë„ˆëŠ” ì–´ë–»ê²Œ í•´?",
        "ìŠ¤ìŠ¤ë¡œë¥¼ ëŒì•„ë´¤ì„ ë•Œ ë– ì˜¤ë¥´ëŠ” ìƒê°ì€ ì–´ë–¤ ê²Œ ë§ì•„?"
    ],
    "ìì œë ¥": [
        "í™”ê°€ ë‚  ë•Œ ë³´í†µ ì–´ë–»ê²Œ í’€ì–´?",
        "ì¶©ë™ì ìœ¼ë¡œ í–‰ë™í–ˆë˜ ê²½í—˜ì´ ìµœê·¼ì— ìˆì—ˆì–´?",
        "ê¸°ë¶„ì´ ê²©í•´ì¡Œì„ ë•Œ ìŠ¤ìŠ¤ë¡œë¥¼ ì–´ë–»ê²Œ ì§„ì •ì‹œì¼œ?",
        "í™”ê°€ ë‚˜ë©´ ë°”ë¡œ í‘œí˜„í•˜ëŠ” í¸ì´ì•¼?"
    ],
    "ì‹ ì²´": [
        "ëª¸ì´ ìì£¼ ë¶ˆí¸í•˜ë‹¤ê³  ëŠë‚„ ë•Œê°€ ìˆì–´?",
        "í”¼ê³¤í•˜ê±°ë‚˜ í†µì¦ì´ ìˆì„ ë•Œ í•˜ë£¨ê°€ ì–´ë–»ê²Œ ë‹¬ë¼ì ¸?",
        "ì‹ ì²´ì ì¸ ë¶ˆí¸í•¨ì´ ê°ì •ì—ë„ ì˜í–¥ì„ ì£¼ëŠ” ê²ƒ ê°™ì•„?",
        "ê°€ë” ìˆ¨ì‰¬ê¸° í˜ë“¤ ë•ŒëŠ” ì–¸ì œì•¼?"
    ],
    "ê´€ê³„": [
        "ìµœê·¼ì— ì¹œêµ¬ë“¤ì´ë‘ ìˆì—ˆë˜ ì¼ ì¤‘ ê¸°ì–µì— ë‚¨ëŠ” ê²Œ ìˆì–´?",
        "ê°€ì¡±ë“¤ì´ë‘ ì§€ë‚´ë©´ì„œ í¸ì•ˆí–ˆë˜ ìˆœê°„ì´ ìˆì—ˆì–´?",
        "ì‚¬ëŒë“¤ê³¼ ì–´ìš¸ë¦´ ë•Œ ì£¼ë¡œ ì–´ë–¤ ê¸°ë¶„ì´ ë“¤ì–´?",
        "ì£¼ë³€ ì‚¬ëŒë“¤ì—ê²Œ ì‰½ê²Œ ë§ ëª»í•˜ëŠ” ê³ ë¯¼ì´ ìˆë‹ˆ?"
    ]
}

# ì–´ë¯¸ ë¦¬ìŠ¤íŠ¸ (ìì—°ìŠ¤ëŸ¬ìš´ ë³€ì£¼ ì¶”ê°€)
endings = [""]

# ê¸°ë³¸ ë‹µë³€
default_responses = [
    "ìŒâ€¦ ì˜ ëª¨ë¥´ê² ì–´.",
    "ê·¸ë ‡êµ¬ë‚˜~ ì¢€ ë” ì–˜ê¸°í•´ì¤„ë˜?",
    "í¥ë¯¸ë¡­ë„¤ ",
    "ì¬ë°ŒëŠ” ì–˜ê¸°ì•¼!"
]
# === ìƒíƒœ ê´€ë¦¬ ===
current_category = None
question_index = 0
mode = None  # daily / diagnostic

def save_message(user_id, role, message):
    conn = sqlite3.connect("chat_history.db")
    cur = conn.cursor()
    cur.execute("INSERT INTO chat_log (user_id, role, message) VALUES (?, ?, ?)",
                (user_id, role, message))
    conn.commit()
    conn.close()


def classify_and_respond(user_input, user_id):
    save_message(user_id, "user", user_input)

    # ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ ì‘ë‹µ
    for category, keywords in daily_categories.items():
        for kw in keywords:
            if kw in user_input:
                reply = random.choice(daily_responses.get(category, default_responses))
                save_message(user_id, "bot", reply)
                return reply

    reply = random.choice(default_responses)
    save_message(user_id, "bot", reply)
    return reply


def save_message(user_id, role, message):
    conn = sqlite3.connect("chat_history.db")
    cur = conn.cursor()
    cur.execute("INSERT INTO chat_log (user_id, role, message) VALUES (?, ?, ?)",
                (user_id, role, message))
    conn.commit()
    conn.close()

