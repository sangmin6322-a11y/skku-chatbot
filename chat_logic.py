import random
from flask import current_app

# === ê°ì • + ì¼ìƒ ëŒ€í™” í†µí•© ì¹´í…Œê³ ë¦¬ ===
daily_categories = {
    "ì¸ì‚¬": ["ì•ˆë…•", "í•˜ì´", "ë°˜ê°€ì›Œ", "ì•ˆë…•í•˜ì„¸ìš”"],
    "ë°¥": ["ë°¥", "ë°°ê³ íŒŒ", "ì¹˜í‚¨", "í”¼ì", "ë¼ë©´", "ë–¡ë³¶ì´"],
    "ë‚ ì”¨": ["ë‚ ì”¨", "ë¹„", "ëˆˆ", "ë”ì›Œ", "ì¶”ì›Œ", "ê°€ì„"],
    "ì·¨ë¯¸": ["ê²Œì„", "ì˜í™”", "ìœ íŠœë¸Œ", "ìš´ë™", "ë…¸ë˜", "ì—¬í–‰"],
    "ê³µë¶€": ["ê³µë¶€", "ì‹œí—˜", "í•™êµ", "ê³¼ì œ", "ìˆ˜ì—…", "í•™ì "],
    "ê´€ê³„": ["ì¹œêµ¬", "ê°€ì¡±", "ì—°ì• ", "ë‚¨ì¹œ", "ì—¬ì¹œ", "ë™ì•„ë¦¬"]
}

emotion_categories = {
    "ê¸°ë¶„": ["ê¸°ë¶„", "ë¬´ê¸°ë ¥", "ì§œì¦", "ìš°ìš¸", "ë¶ˆì•ˆ", "ìŠ¬í¼", "í”¼ê³¤"],
    "ì ": ["ì ", "ì¡¸ë ¤", "ë¶ˆë©´", "ëª»ì", "ìˆ™ë©´"],
    "ë°¥": ["ì…ë§›", "ë°°ê³ íŒŒ", "ì‹ìš•ì—†", "í­ì‹", "êµ¶ìŒ"],
    "ì§‘ì¤‘": ["ì§‘ì¤‘", "ì‚°ë§Œ", "ê³µë¶€ì•ˆë¨"],
    "ì‚¬ê³ ": ["ìƒê°", "ë¹„ê´€", "ì£½ê³  ì‹¶", "í¬ë§ì—†", "ë¬´ì˜ë¯¸"],
    "ì‹ ì²´": ["ë‘í†µ", "ë³µí†µ", "ì†ì“°ë¦¼", "ì–´ì§€ëŸ¬"],
    "ê´€ê³„": ["ì™¸ë¡œì›€", "ì™•ë”°", "ì‚¬ëŒì‹«ì–´"]
}

daily_responses = {
    "ì¸ì‚¬": ["ì•ˆë…•! ë§Œë‚˜ì„œ ë°˜ê°€ì›Œ ğŸ˜Š", "í•˜ì´~ ì˜¤ëŠ˜ ê¸°ë¶„ ì–´ë•Œ?", "ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ê³  ìˆì§€?"],
    "ë°¥": ["ë°¥ì€ ë¨¹ì—ˆì–´?", "ì˜¤ëŠ˜ ë­ ë¨¹ì—ˆì–´?", "ìš”ì¦˜ ë­ê°€ ë§›ìˆì–´?"],
    "ë‚ ì”¨": ["ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë• ì–´?", "ë¹„ ì˜¤ëŠ” ë‚  ì¢‹ì•„í•´?", "ìš”ì¦˜ ì¢€ ìŒ€ìŒ€í•˜ì§€ ì•Šì•„?"],
    "ì·¨ë¯¸": ["ìš”ì¦˜ ë­ í•´?", "ì˜í™” ë´¤ì–´?", "ê²Œì„ ìì£¼ í•´?"],
    "ê³µë¶€": ["ê³µë¶€ í˜ë“¤ì§€?", "ê³¼ì œëŠ” ë‹¤ í–ˆì–´?", "ì‹œí—˜ê¸°ê°„ì´ì•¼?"],
    "ê´€ê³„": ["ì¹œêµ¬ë“¤ì´ë‘ ì˜ ì§€ë‚´?", "ê°€ì¡±ì€ ì˜ ìˆì–´?", "ìš”ì¦˜ ì™¸ë¡­ì§€ ì•Šì•„?"]
}

emotion_responses = {
    "ê¸°ë¶„": ["ìš”ì¦˜ ê°ì • ê¸°ë³µì´ ì¢€ ìˆë‚˜ë´?", "ìµœê·¼ì— ì›ƒì€ ì  ìˆì–´?", "ê¸°ë¶„ì´ ìì£¼ ê°€ë¼ì•‰ëŠ” í¸ì´ì•¼?"],
    "ì ": ["ìš”ì¦˜ ì ì€ ì˜ ì?", "ë°¤ì— ì ë“¤ê¸° í˜ë“  í¸ì´ì•¼?"],
    "ë°¥": ["ìš”ì¦˜ ì…ë§›ì€ ì–´ë•Œ?", "ì‹ì‚¬ ê±°ë¥´ì§€ ë§ê³  ì±™ê²¨ ë¨¹ì."],
    "ì§‘ì¤‘": ["ì§‘ì¤‘ì´ ì˜ ì•ˆ ë¼?", "ê³µë¶€í•  ë•Œ ì‚°ë§Œí•˜ë‹¤ê³  ëŠê»´ì ¸?"],
    "ì‚¬ê³ ": ["ìš”ì¦˜ ìì£¼ í•˜ëŠ” ìƒê°ì´ ìˆì–´?", "ìŠ¤ìŠ¤ë¡œì— ëŒ€í•œ ìƒê°ì´ ë¶€ì •ì ì¼ ë•Œê°€ ìˆì§€?"],
    "ì‹ ì²´": ["ìš”ì¦˜ ëª¸ì€ ê´œì°®ì•„?", "í”¼ê³¤ì´ ì˜ ì•ˆ í’€ë ¤?"],
    "ê´€ê³„": ["ìš”ì¦˜ ì™¸ë¡œì›€ì„ ëŠê»´?", "ì‚¬ëŒë“¤ê³¼ ìˆì„ ë•Œ í¸ì•ˆí•´?"]
}

default_responses = ["ìŒâ€¦ ì˜ ëª¨ë¥´ê² ì–´.", "ê·¸ë ‡êµ¬ë‚˜~ ì¢€ ë” ì–˜ê¸°í•´ì¤„ë˜?", "í¥ë¯¸ë¡­ë„¤.", "ì¬ë°ŒëŠ” ì–˜ê¸°ì•¼!"]


def classify_and_respond(user_input, user_id):
    # âœ… ìˆœí™˜ import ë°©ì§€: ì—¬ê¸°ì„œ Flask app context ì•ˆì—ì„œ import
    from app import db, ChatLog  

    with current_app.app_context():
        # ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥
        db.session.add(ChatLog(user_id=user_id, role="user", message=user_input))
        db.session.commit()

        # ê°ì • ì¹´í…Œê³ ë¦¬ ìš°ì„ 
        for category, keywords in emotion_categories.items():
            for kw in keywords:
                if kw in user_input:
                    reply = random.choice(emotion_responses.get(category, default_responses))
                    db.session.add(ChatLog(user_id=user_id, role="bot", message=reply))
                    db.session.commit()
                    return reply

        # ì¼ìƒ ì¹´í…Œê³ ë¦¬
        for category, keywords in daily_categories.items():
            for kw in keywords:
                if kw in user_input:
                    reply = random.choice(daily_responses.get(category, default_responses))
                    db.session.add(ChatLog(user_id=user_id, role="bot", message=reply))
                    db.session.commit()
                    return reply

        # ê¸°ë³¸ ì‘ë‹µ
        reply = random.choice(default_responses)
        db.session.add(ChatLog(user_id=user_id, role="bot", message=reply))
        db.session.commit()
        return reply
