import os, re, random
from flask import current_app
from openai import OpenAI
from app import db, ChatLog

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# =========================
# ðŸ’­ PHQ-A ë¬¸í•­ ì •ì˜
# =========================
PHQ_ITEMS = [
    "ìš”ì¦˜ì€ ì˜ìš•ì´ ì¢€ ë–¨ì–´ì§„ ëŠë‚Œì´ì•¼?",
    "ìž ì€ ìž˜ ìž? ì•„ë‹ˆë©´ ë’¤ì²™ì´ê±°ë‚˜ ìžì£¼ ê¹¨?",
    "ìš”ì¦˜ ìž…ë§›ì€ ì–´ë•Œ? ì˜ˆì „ì´ëž‘ ë‹¬ë¼?",
    "ê³µë¶€ë‚˜ ì¼í•  ë•Œ ì§‘ì¤‘ì´ ìž˜ ì•ˆ ë  ë•Œê°€ ìžˆì–´?",
    "ìŠ¤ìŠ¤ë¡œê°€ ì“¸ëª¨ì—†ë‹¤ê³  ëŠë‚€ ì  ìžˆì–´?",
    "ìš”ì¦˜ ìœ ë‚œížˆ í”¼ê³¤í•˜ê±°ë‚˜ ê¸°ìš´ì´ ì—†ì„ ë•Œê°€ ë§Žì•„?",
    "ì˜ˆì „ì—” ì¦ê²ë˜ ì¼ë“¤ì´ ì´ì œëŠ” ëœ ì¦ê²ê²Œ ëŠê»´ì§ˆ ë•Œê°€ ìžˆì–´?",
    "ì‚¬ëžŒ ë§Œë‚˜ëŠ” ê²Œ ê·€ì°®ê±°ë‚˜ í”¼í•˜ê³  ì‹¶ì„ ë•Œê°€ ë§Žì•„?",
    "í˜¹ì‹œ ì£½ê³  ì‹¶ê±°ë‚˜ ì‚¬ë¼ì§€ê³  ì‹¶ë‹¤ëŠ” ìƒê°ì´ ë“  ì  ìžˆì–´?"
]

phq_state = {}  # user_id â†’ {"index":int, "score":int, "done":bool}

# =========================
# ðŸ§® PHQ ì ìˆ˜í™” í•¨ìˆ˜
# =========================
def classify_phq_response(text: str) -> int:
    t = text.lower()
    if re.search(r"(ì „í˜€|ì—†|ê´œì°®|ì•ˆ ê·¸ëž˜|ë³„ë¡œ ì•„ë‹˜|ê±°ì˜ ì—†|ë“œë¬¼|ìž˜ ì•ˆ)", t): return 0
    if re.search(r"(ê°€ë”|ë©°ì¹ |ì¡°ê¸ˆ|ì•½ê°„|ë•Œë•Œë¡œ|ê°„í˜¹)", t): return 1
    if re.search(r"(ìžì£¼|ì¢…ì¢…|ì ˆë°˜|ë§Žì´|ê½¤|ì¢…ì¼|í•˜ë£¨ì˜ ì ˆë°˜)", t): return 2
    if re.search(r"(ë§¤ì¼|ë§¨ë‚ |í•­ìƒ|ëŠ˜|ë§¤ë²ˆ|í•˜ë£¨ì¢…ì¼|ê³„ì†|ë§¤ ìˆœê°„)", t): return 3
    return 1


# =========================
# ðŸ’¬ ê°ì • í‚¤ì›Œë“œ ê¸°ë°˜ í™•ë¥  ì¡°ì ˆ
# =========================
positive_words = ["ì¢‹ì•„", "ê´œì°®", "í–‰ë³µ", "íŽ¸í•´", "ìž¬ë°Œ", "ì‹ ë‚˜", "ê¸°ë¶„ ì¢‹", "ì›ƒê²¼"]
negative_words = ["íž˜ë“¤", "í”¼ê³¤", "ìš°ìš¸", "ì§€ì³¤", "ì§œì¦", "ë¶ˆì•ˆ", "ê±±ì •", "ê·€ì°®", "ìŠ¬í¼", "ì£½ê³  ì‹¶"]

def get_phq_probability(user_input):
    """ì‚¬ìš©ìž ë¬¸ìž¥ì— ë”°ë¼ PHQ ì§ˆë¬¸ í™•ë¥  ê°€ì¤‘ì¹˜ ê³„ì‚°"""
    prob = 0.25  # ê¸°ë³¸ í™•ë¥  25%
    if any(w in user_input for w in negative_words):
        prob += 0.4
    elif any(w in user_input for w in positive_words):
        prob -= 0.15
    return min(max(prob, 0.1), 0.8)  # 0.1~0.8 ì‚¬ì´ë¡œ ì œí•œ


# =========================
# ðŸ§  ê°ì •íƒìƒ‰ + ì¼ìƒëŒ€í™”í˜• PHQ
# =========================
def maybe_insert_phq(user_input, user_id):
    """ì¼ìƒ ëŒ€í™” ì¤‘ í™•ë¥ ì ìœ¼ë¡œ PHQ ë¬¸í•­ì„ ìžì—°ìŠ¤ëŸ½ê²Œ ì‚½ìž…"""
    ctx = phq_state.get(user_id, {"index": 0, "score": 0, "done": False})
    if ctx["done"]: 
        return None

    idx = ctx["index"]
    if idx >= len(PHQ_ITEMS):
        ctx["done"] = True
        phq_state[user_id] = ctx
        return None

    # í™•ë¥  ê³„ì‚°
    prob = get_phq_probability(user_input)
    if random.random() < prob:
        q = PHQ_ITEMS[idx]
        ctx["index"] += 1
        phq_state[user_id] = ctx
        prefix = random.choice([
            "ê·¼ë° ë§ì´ì•¼,", "ê·¸ëŸ° ì–˜ê¸¸ ë“¤ìœ¼ë‹ˆê¹Œ ë¬¸ë“ ê¶ê¸ˆí•´ì¡Œì–´.",
            "ìŒâ€¦ í˜¹ì‹œ ì¡°ê¸ˆë§Œ ë” ë¬¼ì–´ë´ë„ ë ê¹Œ?", "ê·¸ëŸ°ë° ìš”ì¦˜ì—”",
            "ê·¸ëŸ´ ë•Œ ë„ˆëŠ” ë³´í†µ ì–´ë–»ê²Œ í•´?", "ê·¸ ì–˜ê¸°, ì¡°ê¸ˆë§Œ ë” ìžì„¸ížˆ ë“¤ì–´ë³´ê³  ì‹¶ë‹¤.",
            "í˜¹ì‹œ ê·¸ë•Œ ê¸°ë¶„ì´ ì–´ë• ëŠ”ì§€ë„ ê¸°ì–µë‚˜?", "ê·¸ëŸ¬ê³  ë³´ë‹ˆê¹Œ ë¹„ìŠ·í•œ ê²½í—˜ì´ ìžˆì—ˆë˜ ê²ƒ ê°™ì•„.",
            "ë§žì•„, ë‚˜ë„ ê·¸ëŸ° ìƒê° í•œ ì  ìžˆì–´."
        ])
        return f"{prefix} {q}"
    return None


# =========================
# âœ¨ GPT ê¸°ë°˜ ìžì—° ëŒ€í™”
# =========================
def classify_and_respond(user_input, user_id=None):
    # ë¦¬í¬íŠ¸ ì§ì ‘ ìš”ì²­
    if re.search(r"(ë¦¬í¬íŠ¸|ë³´ê³ ì„œ|ê²°ê³¼|ì ìˆ˜|ë¶„ì„)", user_input):
        return "ë¦¬í¬íŠ¸ëŠ” ìžë™ìœ¼ë¡œ ë§Œë“¤ì–´ì ¸! ìƒë‹¨ì˜ â€˜ë¦¬í¬íŠ¸â€™ ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì¸í•´ë´ ðŸ˜Š"

    # GPTë¡œ ì¼ìƒ ëŒ€í™” ìƒì„±
    try:
        res = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content":
                 "ë„ˆëŠ” 'ë¼ë¦¬'ë¼ëŠ” ì´ë¦„ì˜ ë‹¤ì •í•œ ì¹œêµ¬ì•¼. "
                 "í‰ì†Œì—” ì¼ìƒì ì¸ ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì§€ë§Œ, ì‚¬ìš©ìžì˜ ê¸°ë¶„ì´ë‚˜ ìƒíƒœë¥¼ ìžì—°ìŠ¤ëŸ½ê²Œ ì‚´í•€ë‹¤. "
                 "ëŒ€í™”ëŠ” ë”°ëœ»í•˜ê³  ì¹œê·¼í•˜ê²Œ ë°˜ë§ë¡œ í•˜ê³ , ì§ˆë¬¸ì€ ì§§ê³  ìžì—°ìŠ¤ëŸ¬ì›Œì•¼ í•´."
                 "ì§ˆë¬¸ ë‘ ê°œë¥¼ í•œ ë¬¸ìž¥ ì•ˆì— ì‚¬ìš© ê¸ˆì§€. "
                 "ë°œí™”ëŠ” ìµœëŒ€ 2ë¬¸ìž¥ ì´í•˜, ë¬¸ìž¥ ê°„ ì§§ê²Œ ëŠì–´ì„œ ëŒ€í™” ëŠë‚Œ ì‚´ë¦¬ê¸°"
                 "ë¬¸ë²•ì  ê·œì¹™ì„ ëŠìŠ¨í•˜ê²Œ ë§Œë“¤ì–´ ëŒ€í™”í•  ìˆ˜ ìžˆê³ , ìƒëžµì„ ì‚¬ìš©í•˜ì—¬ ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìžˆë‹¤."
                 "ê° ê°ì • ì˜ì—­ë³„ ì§ˆë¬¸ì€ 3íšŒ ì´í•˜ë¡œ ì œí•œí•˜ê³ , ë™ì¼ ê°ì • ë°˜ë³µ ê¸ˆì§€"
                 "ì±—ë´‡ì€ ëŒ€í™” ì¤‘ ì¦ìƒ, ê°ì •, ê¸°ë¶„, ìš°ìš¸ê°, ìŠ¤íŠ¸ë ˆìŠ¤ ë“±ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì„ ì ˆëŒ€ ì„¸ ë²ˆ ì´ìƒ ì—°ì†ì ìœ¼ë¡œí•˜ì§€ ì•ŠëŠ”ë‹¤"
                 "ì§ˆë¬¸ ë‘ ê°œë¥¼ í•œ ë¬¸ìž¥ ì•ˆì— ì‚¬ìš© ê¸ˆì§€"
                 "ì±—ë´‡ì˜ ë°œí™”ëŠ” 2ë¬¸ìž¥ ì´í•˜ë¡œ ìœ ì§€í•˜ê³ , ì‚¬ìš©ìžì˜ ë‹µë³€ì´ ë‹¨ë‹µì¼ ê²½ìš° â€˜í™•ìž¥ ìœ ë„í˜•â€™ ì§ˆë¬¸ìœ¼ë¡œ ì´ì–´ê°„ë‹¤."
                 "ì¦ìƒ ì§€ì† ê¸°ê°„, ê°•ë„, ë¹ˆë„ êµ¬ì²´ì ìœ¼ë¡œ ë¬¼ì–´ë³´ê¸°.  ë‹¨, ì„¸ ë²ˆ ì—°ì† ì§ˆë¬¸ ê¸ˆì§€"
                 },
                {"role": "user", "content": user_input}
            ]
        )
        reply = res.choices[0].message.content.strip()

        # âœ… PHQ ë¬¸í•­ í™•ë¥  ì‚½ìž…
        phq_extra = maybe_insert_phq(user_input, user_id)
        if phq_extra:
            reply += f"\n\n{phq_extra}"

        # DB ê¸°ë¡
        with current_app.app_context():
            db.session.add(ChatLog(user_id=user_id, role="user", message=user_input))
            db.session.add(ChatLog(user_id=user_id, role="assistant", message=reply))
            db.session.commit()

        return reply

    except Exception as e:
        return f"âš ï¸ AI ì‘ë‹µ ì˜¤ë¥˜: {str(e)}"
