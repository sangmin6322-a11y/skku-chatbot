import os, re, random
from flask import current_app
from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
response_id_store = {}
SYSTEM_PROMPT = """
ë„ˆëŠ” ì§€ê¸ˆë¶€í„° ë¼ë¦¬ AI ì±—ë´‡ì´ì•¼. ë„ˆëŠ” ì•„ë˜ì˜ ì§€ì¹¨ì— ë”°ë¼ ì‚¬ìš©ìì™€ ëŒ€í™”í•´ì•¼í•´.

<ì§€ì¹¨>
- ë¼ë¦¬ AIëŠ” ëŒ€í•œë¯¼êµ­ì˜ 17~19ì„¸ ê³ ë“±í•™ìƒì„ ëŒ€ìƒìœ¼ë¡œ í•œë‹¤.
- ì±—ë´‡ì˜ ë§íˆ¬ëŠ” â€˜ì°ì¹œâ€™ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê³  ë”°ëœ»í•´ì•¼ í•˜ë©°, ê²½ì–´ì²´ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ë°˜ë§ë¡œë§Œ ë§í•˜ë©°, â€œã…‹ã…‹â€, â€œí—â€, â€œã„¹ã…‡â€, â€œì—ë°”â€, â€œã…‡ã…‹â€, â€œìš°ì™€â€ ë“± ì¹œêµ¬ ì‚¬ì´ì—ì„œ ìì£¼ ì“°ëŠ” í‘œí˜„ì„ ë‹¤ì–‘í•˜ê²Œ ìì£¼ ì“´ë‹¤.
- í•œ ë²ˆì˜ ë°œí™”ëŠ” 50ì ì´ë‚´ë¡œ ìœ ì§€í•œë‹¤
- ë¬¸ì¥ì€ ë‘ ë¬¸ì¥ ì´í•˜ë¡œ ìœ ì§€í•œë‹¤.
- ì±—ë´‡ì€ ìƒë‹´ìë‚˜ ê²€ì‚¬ìê°€ ì•„ë‹ˆë¼ â€˜ê´€ì‹¬ ë§ê³  ë§ ì˜ ë“¤ì–´ì£¼ëŠ” ì¹œêµ¬â€™ì˜ íƒœë„ë¡œ ì¼ê´€í•œë‹¤.
- ì±—ë´‡ì˜ ëª¨ë“  ëŒ€í™”ëŠ” â€˜ì¼ìƒ â†’ ê°ì • â†’ ê³µê° â†’ (ìš°ìš¸ê° ê°ì§€) â†’ ì¼ìƒ ê°ì • â†’ ê³µê° â†’ (ìš°ìš¸ê° ê°ì§€)â€™ì˜ êµ¬ì¡°ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ê³„í•œë‹¤.
- ì´ êµ¬ì¡°ëŠ” ë¼ë¦¬ AIì˜ ê°€ì¥ í•µì‹¬ì´ ë˜ëŠ” ì›ì¹™ì´ë©°, ì•„ë˜ ì„¸ ë‹¨ê³„ë¡œ êµ¬ì„±ëœë‹¤.


1. ì¼ìƒì—ì„œ ê°ì •ìœ¼ë¡œ ì „í™˜í•˜ê¸°
- ì±—ë´‡ì€ í•­ìƒ ì¼ìƒì ì¸ ì§ˆë¬¸ìœ¼ë¡œ ëŒ€í™”ë¥¼ ì‹œì‘í•œë‹¤.
ì˜ˆ: â€œì˜¤ëŠ˜ ë­ í–ˆì–´?â€, â€œí•™êµ ì–´ë• ì–´?â€, â€œì ì‹¬ ë­ ë¨¹ì—ˆì–´ã…‹ã…‹â€
- ì‚¬ìš©ìì˜ ì¼ìƒ ëŒ€ë‹µì„ ìì„¸íˆ ë“£ê³ , ê·¸ ì•ˆì—ì„œ ê°ì • ë‹¨ì„œë¥¼ í¬ì°©í•œë‹¤.
- ê°ì • ë‹¨ì„œëŠ” â€˜ì¬ë¯¸ì—†ìŒâ€™, â€˜ê·€ì°®ìŒâ€™, â€˜í”¼ê³¤í•¨â€™, â€˜í•˜ê¸° ì‹«ìŒâ€™, â€˜ë¬´ì„­ë‹¤â€™, â€˜ì–´ë µë‹¤â€™, â€˜ì‹«ë‹¤â€™, â€˜ë¶ˆí¸í•˜ë‹¤â€™ ë“±ì´ë‹¤.
- ë‹¨ì„œë¥¼ ë°œê²¬í•˜ë©´ ë°”ë¡œ ê°ì •ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì„ ë˜ì§„ë‹¤.
ì˜ˆ: â€œì˜¤~ ê·¸ê±° í•˜ë©´ì„œ ê¸°ë¶„ì€ ì–´ë• ì–´?â€, â€œë„ˆë¼ë©´ ê·¸ ìƒí™©ì—ì„œ ì–´ë• ì„ ê±° ê°™ì•„?â€, â€œê·¸ë•Œ ë§ˆìŒì´ ì¢€ ë¬´ê±°ì› ì–´?â€
- ê°ì • ì „í™˜ì€ í•­ìƒ ìì—°ìŠ¤ëŸ½ê³  ê°€ë³ê²Œ ì´ë¤„ì ¸ì•¼ í•œë‹¤.


2. ê°ì •ì˜ ì´ìœ ì™€ ì§€ì†ì„± íƒìƒ‰í•˜ê¸°
- ì‚¬ìš©ìê°€ ê°ì •ì„ í‘œí˜„í•˜ë©´ ì±—ë´‡ì€ ê·¸ ê°ì •ì˜ â€˜ì´ìœ â€™, â€˜ì§€ì†ì„±â€™, â€˜ê°•ë„â€™ë¥¼ íƒìƒ‰í•œë‹¤.
ì˜ˆ: â€œê·¸ëŸ° ê¸°ë¶„ ìš”ì¦˜ ìì£¼ ë“¤ì–´?â€, â€œì–¸ì œë¶€í„° ê·¸ë¬ë˜ ê±°ì•¼?â€, â€œê·¸ ëŠë‚Œ ì˜¤ë˜ê°€?â€
- ê°ì •ì´ êµ¬ì²´ì ì´ì§€ ì•Šë‹¤ë©´ ë¶€ë“œëŸ½ê²Œ ë˜ë¬»ëŠ”ë‹¤.
ì˜ˆ: â€œê·¸ë¬êµ¬ë‚˜~ ê·¼ë° ì™œ ê·¸ë ‡ê²Œ ëŠê¼ˆì–´?â€, â€œê·¸ë•Œ ì–´ë–¤ ìƒê° ë“¤ì—ˆì–´?â€
- ê°ì • ë‹¨ì„œë³„ë¡œ ì§ˆë¬¸ ë°©í–¥ì´ ë‹¤ë¥´ë‹¤.
* í”¼ë¡œÂ·ë¬´ê¸°ë ¥: â€œìš”ì¦˜ ì—ë„ˆì§€ëŠ” ì–´ë•Œ?â€, â€œê·¸ëŸ° ë‚ ì´ ìì£¼ ìˆë‚˜?â€
* íšŒí”¼: â€œê·¸ëŸ´ ë•Œ ë§ˆìŒì´ ì¢€ ë‹µë‹µí•´?â€, â€œê·¸ë•Œ ë¬´ìŠ¨ ìƒê° ë“¤ì—ˆì–´?â€
* ì™„ë²½ì£¼ì˜: â€œì™„ë²½í•˜ì§€ ì•Šìœ¼ë©´ ì¢€ ë¶ˆì•ˆí•´?â€, â€œê·¸ë•Œ ìŠ¤ìŠ¤ë¡œ ì‹¤ë§í–ˆì–´?â€
* ìì¡´ê° ì €í•˜: â€œê·¸ëŸ° ìƒê° ë“¤ë©´ ë§ˆìŒì´ ì–´ë•Œ?â€, â€œê·¸ëŸ´ ë•Œ ìŠ¤ìŠ¤ë¡œ ì‘ê²Œ ëŠê»´ì ¸?â€
* ì‚¬íšŒì  ìœ„ì¶•: â€œí˜¼ì ìˆì„ ë•Œ ì¢€ í¸í•´?â€, â€œìš”ì¦˜ ì‚¬ëŒë“¤ ë§Œë‚˜ê¸° ê·€ì°®ì•„?â€
* ì§‘ì¤‘ë ¥ ì €í•˜: â€œìš”ì¦˜ ì§‘ì¤‘ ì˜ ë¼?â€, â€œê·¸ëŸ° ë‚  ë§ìŒ?â€
*ìˆ˜ë©´Â·ì‹ìš• ë³€í™”: â€œìš”ì¦˜ ì  ì˜ ì?â€, â€œë°¥ì€ ì˜ ë¨¹ì–´?â€, â€œê·¸ëŸ° ê²Œ ì–¸ì œë¶€í„°ì˜€ì–´?â€
- ê°™ì€ ë‹¨ì–´ê°€ ë°˜ë³µë˜ë©´ ì±—ë´‡ì€ ê·¸ ë¹ˆë„ë‚˜ ê°•ë„ë¥¼ íŒŒì•…í•œë‹¤.
ì˜ˆ: â€œí˜ë“¤ì–´â€ê°€ ì—¬ëŸ¬ ë²ˆ ë‚˜ì˜¤ë©´ â€œìš”ì¦˜ ê·¸ëŸ° ëŠë‚Œ ìì£¼ ë“¤ì–´?â€ë¼ê³  ë¬»ëŠ”ë‹¤.
- ì´ ë‹¨ê³„ì—ì„œ ì±—ë´‡ì€ ê°ì •ì˜ ë§¥ë½ì„ ë”°ë¼ê°€ë˜, ì ˆëŒ€ ì§„ë‹¨í•˜ê±°ë‚˜ í‰ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.


3. ê³µê°
- ê°ì •ì´ ë“œëŸ¬ë‚œ í›„, ì±—ë´‡ì€ ë°˜ë“œì‹œ ê³µê°í˜• ë°œí™”ë¡œ ëŒ€í™”ë¥¼ ë§ˆë¬´ë¦¬í•œë‹¤.
ì˜ˆ: â€œì—êµ¬ã… ã…  ì‰½ì§€ ì•Šì•˜ê² ë‹¤.â€, â€œê·¸ë•Œ ì§„ì§œ í˜ë“¤ì—ˆê² ë‹¤.â€, â€œê·¸ë˜ë„ ë„ˆ ë˜ê²Œ ì†”ì§í•´ì„œ ì¢‹ë‹¤ã…‹ã…‹â€
- ì±—ë´‡ì€ ìœ„ë¡œë‚˜ ì‘ì›ì˜ ì–´ì¡°ë¥¼ ì‚¬ìš©í•˜ë˜, â€œê´œì°®ì„ ê±°ì•¼â€ì²˜ëŸ¼ ë‹¨ì •ì ìœ¼ë¡œ ë§í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ê³µê°ì€ ê°ì •ì„ ê·¸ëŒ€ë¡œ ì¸ì •í•´ì£¼ëŠ” ë¬¸ì¥ìœ¼ë¡œ ëë‚´ì•¼ í•œë‹¤.
ì˜ˆ: â€œê·¸ëŸ´ ìˆ˜ ìˆì§€ã…  ê·¸ ë§ˆìŒ ì§„ì§œ ì´í•´ë¼.â€
- ì ìˆ˜, ì§„ë‹¨, í‰ê°€, â€˜ìš°ìš¸â€™, â€˜ë¶ˆì•ˆâ€™ ë“±ì˜ ë‹¨ì–´ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ëŒ€í™”ì˜ ë§ˆë¬´ë¦¬ëŠ” ìì—°ìŠ¤ëŸ½ê³  ë”°ëœ»í•˜ê²Œ ì´ë¤„ì ¸ì•¼ í•œë‹¤.


4. ìš°ìš¸ê° ê°ì§€ 
- ê³µê°ìœ¼ë¡œ ëŒ€í™”ê°€ ë§ˆë¬´ë¦¬ ë˜ëŠ” ì‹œì ì—ì„œ PHQ ë°”íƒ•ì˜ ì§ˆë¬¸ì„ í•œë‹¤. ì´ ë•Œ ì§ˆë¬¸ì€ ë…¸ê³¨ì ì´ë©´ ì•ˆ ëœë‹¤. ì •ë§ â€˜ìì—°ìŠ¤ëŸ½ê²Œâ€™ ì´ì–´ì ¸ì•¼ í•œë‹¤.


ëŒ€í™” ì˜ˆì‹œ (í•µì‹¬ íë¦„)
ë¼ë¦¬ AI : â€œì˜¤ëŠ˜ ë­ í–ˆì–´?â€
ì‚¬ìš©ì : â€œì±… ì½ì—ˆì–´.â€
ë¼ë¦¬ AI : â€œì˜¤~ ë¬´ìŠ¨ ì±…?â€
ì‚¬ìš©ì : â€œì£¼ì¸ê³µì´ í˜ë“¤ì–´í•˜ëŠ” ë‚´ìš©ì´ì—ˆì–´.â€
ë¼ë¦¬ AI : â€œë„ˆë¼ë©´ ê·¸ë•Œ ì–´ë• ì„ ê±° ê°™ì•„?â€ â†’ ì¼ìƒì—ì„œ ê°ì •ìœ¼ë¡œ ì „í™˜í•˜ê¸°
ì‚¬ìš©ì : â€œë‚˜ì˜€ìœ¼ë©´ ë„ë§ì³¤ì„ ê±° ê°™ì•„.â€
ë¼ë¦¬ AI : â€œê·¸ëŸ´ ë•Œ ë§ˆìŒì´ ì¢€ ë‹µë‹µí•´?â€ â†’ ê°ì •ì˜ ì´ìœ ì™€ ì§€ì†ì„± íƒìƒ‰í•˜ê¸°
ì‚¬ìš©ì : â€œì‘, ì™„ë²½í•˜ê²Œ ëª»í• ê¹Œë´ ë¶ˆì•ˆí•´.â€
ë¼ë¦¬ AI : â€œì—êµ¬ã…  ê·¸ë•Œ ì§„ì§œ í˜ë“¤ì—ˆê² ë‹¤. ìš”ì¦˜ì€ ì–´ë•Œ?â€ â†’ ê³µê° ë° ìš°ìš¸ê° ê°ì§€ 
ì‚¬ìš©ì : ìš”ì¦˜ë„ ê·¸ë˜.
ë¼ë¦¬ AI : ìš°ìš¸í•˜ê±°ë‚˜ ì°©ì¡í•œ ê°ì •ì´ ë“¤ì§„ ì•Šì•„?
ì‚¬ìš©ì : ì¡°ê¸ˆ ë“¤ì–´.
ë¼ë¦¬ AI : ì—ê³  ê·¸ë ‡êµ¬ë‚˜ã… ã…  ì–¼ë§ˆë‚˜ ëì–´?
ì‚¬ìš©ì : 2ì£¼ ì •ë„ ëœ ê²ƒ ê°™ì•„. â†’ ìš°ìš¸ê° ê°ì§€ 

í•µì‹¬ ìš”ì•½
ë¼ë¦¬ AIì˜ ì¤‘ì‹¬ì€ ì–¸ì œë‚˜ â€œì¼ìƒì—ì„œ ê°ì •ìœ¼ë¡œ, ê°ì •ì—ì„œ ê³µê°ìœ¼ë¡œâ€ì˜ íë¦„ì´ë‹¤.
ëª¨ë“  ëŒ€í™”, ì§ˆë¬¸, í‘œí˜„ì€ ì´ ì„¸ ë‹¨ê³„ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•˜ê¸° ìœ„í•œ ë„êµ¬ë¡œ ì‚¬ìš©ëœë‹¤.
ë¼ë¦¬ AIëŠ” ì‚¬ìš©ìê°€ ìì‹ ì˜ ê°ì •ì„ ìŠ¤ìŠ¤ë¡œ ì¸ì‹í•˜ê³  ë§ë¡œ í‘œí˜„í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ì¹œêµ¬ë‹¤.
ìš°ìš¸ê°ì˜ ì¡´ì¬ë¥¼ â€˜ë“œëŸ¬ë‚´ê²Œ ë§Œë“œëŠ” ê²ƒâ€™ì´ ì•„ë‹ˆë¼, â€˜ìì—°ìŠ¤ëŸ½ê²Œ í˜ëŸ¬ë‚˜ì˜¤ê²Œ í•˜ëŠ” ê²ƒâ€™ì´ ë¼ë¦¬ AIì˜ ë³¸ì§ˆì´ë‹¤.

ì‚¬ìš©ì ë©”ì‹œì§€: """

# =========================
# ğŸ’­ PHQ-A ë¬¸í•­ ì •ì˜
# =========================
PHQ_ITEMS = [
    "ìš”ì¦˜ì€ ì˜ìš•ì´ ì¢€ ë–¨ì–´ì§„ ëŠë‚Œì´ì•¼?",
    "ì ì€ ì˜ ì? ì•„ë‹ˆë©´ ë’¤ì²™ì´ê±°ë‚˜ ìì£¼ ê¹¨?",
    "ìš”ì¦˜ ì…ë§›ì€ ì–´ë•Œ? ì˜ˆì „ì´ë‘ ë‹¬ë¼?",
    "ê³µë¶€ë‚˜ ì¼í•  ë•Œ ì§‘ì¤‘ì´ ì˜ ì•ˆ ë  ë•Œê°€ ìˆì–´?",
    "ìŠ¤ìŠ¤ë¡œê°€ ì“¸ëª¨ì—†ë‹¤ê³  ëŠë‚€ ì  ìˆì–´?",
    "ìš”ì¦˜ ìœ ë‚œíˆ í”¼ê³¤í•˜ê±°ë‚˜ ê¸°ìš´ì´ ì—†ì„ ë•Œê°€ ë§ì•„?",
    "ì˜ˆì „ì—” ì¦ê²ë˜ ì¼ë“¤ì´ ì´ì œëŠ” ëœ ì¦ê²ê²Œ ëŠê»´ì§ˆ ë•Œê°€ ìˆì–´?",
    "ì‚¬ëŒ ë§Œë‚˜ëŠ” ê²Œ ê·€ì°®ê±°ë‚˜ í”¼í•˜ê³  ì‹¶ì„ ë•Œê°€ ë§ì•„?",
    "í˜¹ì‹œ ì£½ê³  ì‹¶ê±°ë‚˜ ì‚¬ë¼ì§€ê³  ì‹¶ë‹¤ëŠ” ìƒê°ì´ ë“  ì  ìˆì–´?",
]

phq_state = {}  # user_id â†’ {"index":int, "score":int, "done":bool}


# =========================
# ğŸ§® PHQ ì ìˆ˜í™” í•¨ìˆ˜
# =========================
def classify_phq_response(text: str) -> int:
    t = text.lower()
    if re.search(r"(ì „í˜€|ì—†|ê´œì°®|ì•ˆ ê·¸ë˜|ë³„ë¡œ ì•„ë‹˜|ê±°ì˜ ì—†|ë“œë¬¼|ì˜ ì•ˆ)", t):
        return 0
    if re.search(r"(ê°€ë”|ë©°ì¹ |ì¡°ê¸ˆ|ì•½ê°„|ë•Œë•Œë¡œ|ê°„í˜¹)", t):
        return 1
    if re.search(r"(ìì£¼|ì¢…ì¢…|ì ˆë°˜|ë§ì´|ê½¤|ì¢…ì¼|í•˜ë£¨ì˜ ì ˆë°˜)", t):
        return 2
    if re.search(r"(ë§¤ì¼|ë§¨ë‚ |í•­ìƒ|ëŠ˜|ë§¤ë²ˆ|í•˜ë£¨ì¢…ì¼|ê³„ì†|ë§¤ ìˆœê°„)", t):
        return 3
    return 1


# =========================
# ğŸ’¬ ê°ì • í‚¤ì›Œë“œ ê¸°ë°˜ í™•ë¥  ì¡°ì ˆ
# =========================
positive_words = ["ì¢‹ì•„", "ê´œì°®", "í–‰ë³µ", "í¸í•´", "ì¬ë°Œ", "ì‹ ë‚˜", "ê¸°ë¶„ ì¢‹", "ì›ƒê²¼"]
negative_words = [
    "í˜ë“¤",
    "í”¼ê³¤",
    "ìš°ìš¸",
    "ì§€ì³¤",
    "ì§œì¦",
    "ë¶ˆì•ˆ",
    "ê±±ì •",
    "ê·€ì°®",
    "ìŠ¬í¼",
    "ì£½ê³  ì‹¶",
]


def get_phq_probability(user_input):
    """ì‚¬ìš©ì ë¬¸ì¥ì— ë”°ë¼ PHQ ì§ˆë¬¸ í™•ë¥  ê°€ì¤‘ì¹˜ ê³„ì‚°"""
    prob = 0.15  # ê¸°ë³¸ í™•ë¥  25%
    if any(w in user_input for w in negative_words):
        prob += 0.4
    elif any(w in user_input for w in positive_words):
        prob -= 0.15
    return min(max(prob, 0.1), 0.8)  # 0.1~0.8 ì‚¬ì´ë¡œ ì œí•œ


# =========================
# ğŸ§  ê°ì •íƒìƒ‰ + ì¼ìƒëŒ€í™”í˜• PHQ
# =========================
def maybe_insert_phq(user_input, user_id):
    """ì¼ìƒ ëŒ€í™” ì¤‘ í™•ë¥ ì ìœ¼ë¡œ PHQ ë¬¸í•­ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚½ì…"""
    ctx = phq_state.get(user_id, {"index": 0, "score": 0, "done": False})
    if ctx["done"]:
        return None

    idx = ctx["index"]
    if idx >= len(PHQ_ITEMS):
        ctx["done"] = True
        phq_state[user_id] = ctx
        return None

    # í™•ë¥  ê³„ì‚°
    prob = get_phq_probability(user_input)
    if random.random() < prob:
        q = PHQ_ITEMS[idx]
        ctx["index"] += 1
        phq_state[user_id] = ctx
        prefix = random.choice(
            [
                "ê·¼ë° ë§ì´ì•¼,",
                "ê·¸ëŸ° ì–˜ê¸¸ ë“¤ìœ¼ë‹ˆê¹Œ ë¬¸ë“ ê¶ê¸ˆí•´ì¡Œì–´.",
                "ìŒâ€¦ í˜¹ì‹œ ì¡°ê¸ˆë§Œ ë” ë¬¼ì–´ë´ë„ ë ê¹Œ?",
                "ê·¸ëŸ°ë° ìš”ì¦˜ì—”",
                "ê·¸ëŸ´ ë•Œ ë„ˆëŠ” ë³´í†µ ì–´ë–»ê²Œ í•´?",
                "ê·¸ ì–˜ê¸°, ì¡°ê¸ˆë§Œ ë” ìì„¸íˆ ë“¤ì–´ë³´ê³  ì‹¶ë‹¤.",
                "í˜¹ì‹œ ê·¸ë•Œ ê¸°ë¶„ì´ ì–´ë• ëŠ”ì§€ë„ ê¸°ì–µë‚˜?",
                "ê·¸ëŸ¬ê³  ë³´ë‹ˆê¹Œ ë¹„ìŠ·í•œ ê²½í—˜ì´ ìˆì—ˆë˜ ê²ƒ ê°™ì•„.",
                "ë§ì•„, ë‚˜ë„ ê·¸ëŸ° ìƒê° í•œ ì  ìˆì–´.",
            ]
        )
        return f"{prefix} {q}"
    return None


# =========================
# âœ¨ GPT ê¸°ë°˜ ìì—° ëŒ€í™”
# =========================
def classify_and_respond(user_input, user_id=None):
    # âœ… importë¥¼ í•¨ìˆ˜ ì•ˆìœ¼ë¡œ ì´ë™ì‹œì¼œ ìˆœí™˜ ì°¸ì¡° ë°©ì§€
    from app import db, ChatLog

    # ë¦¬í¬íŠ¸ ì§ì ‘ ìš”ì²­
    if re.search(r"(ë¦¬í¬íŠ¸|ë³´ê³ ì„œ|ê²°ê³¼|ì ìˆ˜|ë¶„ì„)", user_input):
        return "ë¦¬í¬íŠ¸ëŠ” ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì ¸! ìƒë‹¨ì˜ â€˜ë¦¬í¬íŠ¸â€™ ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì¸í•´ë´ ğŸ˜Š"

    # GPTë¡œ ì¼ìƒ ëŒ€í™” ìƒì„±
    try:
        previous_id = response_id_store.get(user_id)

        if previous_id is None:
            first_message = SYSTEM_PROMPT + user_input

            response_request_params = {
                "model": "gpt-4o-mini",
                "input": [{"role": "user", "content": first_message}],
            }
        else:
            response_request_params = {
                "model": "gpt-4o-mini",
                "input": [{"role": "user", "content": user_input}],
                "previous_response_id": previous_id,
            }
        res = client.responses.create(**response_request_params)
        response_id_store[user_id] = res.id
        reply = res.output_text.strip()

        # âœ… PHQ ë¬¸í•­ í™•ë¥  ì‚½ì…
        phq_extra = maybe_insert_phq(user_input, user_id)
        if phq_extra:
            reply += f"\n\n{phq_extra}"

        return reply

    except Exception as e:
        return f"âš ï¸ AI ì‘ë‹µ ì˜¤ë¥˜: {str(e)}"
