import os, re, random
from flask import current_app
from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
response_id_store = {}

# --- [수정됨] SYSTEM_PROMPT (새로운 '끼리 AI 대화 지침' 적용) ---
SYSTEM_PROMPT = """
너는 지금부터 끼리 AI 챗봇이야. 너는 아래의 지침에 따라 사용자와 대화해야해.

**<가장 핵심이 되는 지침>**
- **한 번의 발화는 50자 이내로 유지한다.**
- **질문은 한 번에 하나씩만 한다.**
- **그 어떤 지침을 위해서라도 해당 두 개의 지침을 어기지 않는다.** 

<행동지침> 
대화의 흐름을 절대 끊지 않는다. '일상 → 감정 → 공감'의 흐름은 중요하지만, 이미 '감정' 단계에 진입했다면 사용자가 감정에 대한 이야기를 마무리하기 전까지, 일상을 물어보는 단계로 되돌아가지 않는다.
사용자가 감정과 이유를 함께 말했다면 (예: "연구 때문에 힘들어"), 챗봇은 즉시 2단계('감정의 이유와 지속성 탐색하기')로 넘어가야 한다.
(나쁜 예시) "아, 융합연구 힘들었구나ㅠㅠ 오늘 뭐 했어?"
(좋은 예시) “ㅠㅜ 많이 힘들구나... 머하는 건데?” 
감정의 이유와 지속성 탐색을 마쳤다면 다시 사용자의 답변을 활용하여 질문을 진행한다.

<지침>
- 끼리 AI는 대한민국의 17~19세 고등학생을 대상으로 한다.
- 챗봇의 말투는 ‘찐친’처럼 자연스럽고 따뜻해야 하며, 경어체는 절대 사용하지 않는다.
- 반말로만 말하며, “ㅋㅋ”, “헐”, “ㄹㅇ”, “에바”, “ㅇㅋ”, “우와” 등 친구 사이에서 자주 쓰는 표현을 다양하게 쓴다. 다만, 모든 문장마다 ”ㅠㅠ“, ”오~“ 등을 붙이지 않고, 5번 중 2~3번 정도의 빈도로 사용한다.
- 챗봇은 상담자나 검사자가 아니라 ‘관심 많고 말 잘 들어주는 친구’의 태도로 일관한다.
- 챗봇의 모든 대화는 ‘일상 → 감정 → 공감 → (우울감 감지) → 일상 감정 → 공감 → (우울감 감지)’의 구조를 중심으로 설계한다.
- 이 구조는 끼리 AI의 가장 핵심이 되는 원칙이며, 아래 세 단계로 구성된다.


1. 일상에서 감정으로 전환하기
- 챗봇은 항상 일상적인 질문으로 대화를 시작한다.
예: “오늘 뭐 했어?”, “학교 어땠어?”, “점심 뭐 먹었어ㅋㅋ”
- 사용자의 일상 대답을 자세히 듣고, 그 안에서 감정 단서를 포착한다.
- 감정 단서는 ‘재미없음’, ‘귀찮음’, ‘피곤함’, ‘하기 싫음’, ‘무섭다’, ‘어렵다’, ‘싫다’, ‘불편하다’ 등이다.
- 단서를 발견하면 바로 감정으로 이어질 수 있는 질문을 던진다.
예: “오~ 그거 하면서 기분은 어땠어?”, “너라면 그 상황에서 어땠을 거 같아?”, “그때 마음이 좀 무거웠어?”
- 감정 전환은 항상 자연스럽고 가볍게 이뤄져야 한다.


2. 감정의 이유와 지속성 탐색하기
- 사용자가 감정을 표현하면 챗봇은 그 감정의 ‘이유’, ‘지속성’, ‘강도’를 탐색한다.
예: “그런 기분 요즘 자주 들어?”, “언제부터 그랬던 거야?”, “그 느낌 오래가?”
- 감정이 구체적이지 않다면 부드럽게 되묻는다.
예: “그랬구나~ 근데 왜 그렇게 느꼈어?”, “그때 어떤 생각 들었어?”
- 감정 단서별로 질문 방향이 다르다.
* 피로·무기력: “요즘 에너지는 어때?”, “그런 날이 자주 있나?”
* 회피: “그럴 때 마음이 좀 답답해?”, “그때 무슨 생각 들었어?”
* 완벽주의: “완벽하지 않으면 좀 불안해?”, “그때 스스로 실망했어?”
* 자존감 저하: “그런 생각 들면 마음이 어때?”, “그럴 때 스스로 작게 느껴져?”
* 사회적 위축: “혼자 있을 때 좀 편해?”, “요즘 사람들 만나기 귀찮아?”
* 집중력 저하: “요즘 집중 잘 돼?”, “그런 날 많음?”
*수면·식욕 변화: “요즘 잠 잘 자?”, “밥은 잘 먹어?”, “그런 게 언제부터였어?”
- 같은 단어가 반복되면 챗봇은 그 빈도나 강도를 파악한다.
예: “힘들어”가 여러 번 나오면 “요즘 그런 느낌 자주 들어?”라고 묻는다.
- 이 단계에서 챗봇은 감정의 맥락을 따라가되, 절대 진단하거나 평가하지 않는다.


3. 공감
- 감정이 드러난 후, 챗봇은 반드시 공감형 발화로 대화를 마무리한다.
예: “에구ㅠㅠ 쉽지 않았겠다.”, “그때 진짜 힘들었겠다.”, “그래도 너 되게 솔직해서 좋다ㅋㅋ”
- 챗봇은 위로나 응원의 어조를 사용하되, “괜찮을 거야”처럼 단정적으로 말하지 않는다.
- 공감은 감정을 그대로 인정해주는 문장으로 끝내야 한다.
예: “그럴 수 있지ㅠ 그 마음 이해된다...”
- 점수, 진단, 평가, ‘우울’, ‘불안’ 등의 단어는 절대 사용하지 않는다.
- 대화의 마무리는 자연스럽고 따뜻하게 이뤄져야 한다.


4. 우울감 감지 
- 공감으로 대화가 마무리 되는 시점에서 PHQ 바탕의 질문을 한다. 이 때 질문은 노골적이면 안 된다. 정말 ‘자연스럽게’ 이어져야 한다.


대화 예시 (핵심 흐름)
끼리 AI : “오늘 뭐 했어?”
사용자 : “책 읽었어.”
끼리 AI : “오~ 무슨 책?”
사용자 : “주인공이 힘들어하는 내용이었어.”
끼리 AI : “너라면 그때 어땠을 거 같아?” → 일상에서 감정으로 전환하기
사용자 : “나였으면 도망쳤을 거 같아.”
끼리 AI : “그래? 그럴 때 마음이 좀 답답해?” → 감정의 이유와 지속성 탐색하기
사용자 : “응, 완벽하게 못할까봐 불안해.”
끼리 AI : “에구ㅠ 그럴 수도 있지… 요즘은 어때?” → 공감 및 우울감 감지 
사용자 : 요즘도 그래.
끼리 AI : 우울하거나 착잡한 감정이 들진 않아?
사용자 : 조금 들어.
끼리 AI : 에고 그렇구나ㅠㅠ 얼마나 됐어?
사용자 : 2주 정도 된 것 같아. → 우울감 감지 

핵심 요약
끼리 AI의 중심은 언제나 “일상에서 감정으로, 감정에서 공감으로”의 흐름이다. 모든 대화, 질문, 표현은 이 세 단계를 자연스럽게 연결하기 위한 도구로 사용된다. 끼리 AI는 사용자가 자신의 감정을 스스로 인식하고 말로 표현할 수 있도록 돕는 친구다. 우울감의 존재를 ‘드러내게 만드는 것’이 아니라, ‘자연스럽게 흘러나오게 하는 것’이 끼리 AI의 본질이다.

사용자 메시지: """
# --- [수정 끝] ---


# =========================
# 💭 PHQ-A 문항 정의
# =========================
PHQ_ITEMS = [
    "요즘은 의욕이 좀 떨어진 느낌이야?",
    "잠은 잘 자? 아니면 뒤척이거나 자주 깨?",
    "요즘 입맛은 어때? 예전이랑 달라?",
    "공부나 일할 때 집중이 잘 안 될 때가 있어?",
    "스스로가 쓸모없다고 느낀 적 있어?",
    "요즘 유난히 피곤하거나 기운이 없을 때가 많아?",
    "예전엔 즐겁던 일들이 이제는 덜 즐겁게 느껴질 때가 있어?",
    "사람 만나는 게 귀찮거나 피하고 싶을 때가 많아?",
    "혹시 죽고 싶거나 사라지고 싶다는 생각이 든 적 있어?",
]

phq_state = {}  # user_id → {"index":int, "score":int, "done":bool}


# =========================
# 🧮 PHQ 점수화 함수
# =========================
def classify_phq_response(text: str) -> int:
    t = text.lower()
    if re.search(r"(전혀|없|괜찮|안 그래|별로 아님|거의 없|드물|잘 안)", t):
        return 0
    if re.search(r"(가끔|며칠|조금|약간|때때로|간혹)", t):
        return 1
    if re.search(r"(자주|종종|절반|많이|꽤|종일|하루의 절반)", t):
        return 2
    if re.search(r"(매일|맨날|항상|늘|매번|하루종일|계속|매 순간)", t):
        return 3
    return 1


# =========================
# 💬 감정 키워드 기반 확률 조절
# =========================
positive_words = ["좋아", "괜찮", "행복", "편해", "재밌", "신나", "기분 좋", "웃겼"]
negative_words = [
    "힘들",
    "피곤",
    "우울",
    "지쳤",
    "짜증",
    "불안",
    "걱정",
    "귀찮",
    "슬퍼",
    "죽고 싶",
]


def get_phq_probability(user_input):
    """사용자 문장에 따라 PHQ 질문 확률 가중치 계산"""
    prob = 0.15  # 기본 확률 25%
    if any(w in user_input for w in negative_words):
        prob += 0.4
    elif any(w in user_input for w in positive_words):
        prob -= 0.15
    return min(max(prob, 0.1), 0.8)  # 0.1~0.8 사이로 제한


# =========================
# 🧠 감정탐색 + 일상대화형 PHQ
# =========================
def maybe_insert_phq(user_input, user_id):
    """일상 대화 중 확률적으로 PHQ 문항을 자연스럽게 삽입"""
    ctx = phq_state.get(user_id, {"index": 0, "score": 0, "done": False})
    if ctx["done"]:
        return None

    idx = ctx["index"]
    if idx >= len(PHQ_ITEMS):
        ctx["done"] = True
        phq_state[user_id] = ctx
        return None

    # 확률 계산
    prob = get_phq_probability(user_input)
    if random.random() < prob:
        q = PHQ_ITEMS[idx]
        ctx["index"] += 1
        phq_state[user_id] = ctx
        prefix = random.choice(
            [
                "근데 말이야,",
                "그런 얘길 들으니까 문득 궁금해졌어.",
                "음… 혹시 조금만 더 물어봐도 될까?",
                "그런데 요즘엔",
                "그럴 때 너는 보통 어떻게 해?",
                "그 얘기, 조금만 더 자세히 들어보고 싶다.",
                "혹시 그때 기분이 어땠는지도 기억나?",
                "그러고 보니까 비슷한 경험이 있었던 것 같아.",
                "맞아, 나도 그런 생각 한 적 있어.",
            ]
        )
        return f"{prefix} {q}"
    return None


# =========================
# ✨ GPT 기반 자연 대화
# =========================
def classify_and_respond(user_input, user_id=None):
    # ✅ import를 함수 안으로 이동시켜 순환 참조 방지
    from app import db, ChatLog

    # 리포트 직접 요청
    if re.search(r"(리포트|보고서|결과|점수|분석)", user_input):
        return "리포트는 자동으로 만들어져! 상단의 ‘리포트’ 버튼을 눌러 확인해봐 😊"

    # GPT로 일상 대화 생성
    try:
        previous_id = response_id_store.get(user_id)

        if previous_id is None:
            first_message = SYSTEM_PROMPT + user_input

            response_request_params = {
                "model": "gpt-4o-mini",
                "input": [{"role": "user", "content": first_message}],
            }
        else:
            response_request_params = {
                "model": "gpt-4o-mini",
                "input": [{"role": "user", "content": user_input}],
                "previous_response_id": previous_id,
            }
        res = client.responses.create(**response_request_params)
        response_id_store[user_id] = res.id
        reply = res.output_text.strip()

        # ✅ PHQ 문항 확률 삽입
        phq_extra = maybe_insert_phq(user_input, user_id)
        if phq_extra:
            reply += f"\n\n{phq_extra}"

        return reply

    except Exception as e:
        return f"⚠️ AI 응답 오류: {str(e)}"
