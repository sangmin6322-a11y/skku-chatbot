<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ÎÅºÎ¶¨ Ï±óÎ¥á üí¨</title>
  <style>
    :root{
      --bg:#eaf6ff; --blue:#89c9f5; --blue-2:#58aafc; --ink:#2a2a2a;
      --card:#ffffff; --muted:#f1f7fd; --bubble-bot:#f0f8ff; --bubble-user:#d6eaff;
      --shadow:0 8px 20px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg);
      font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;
      display:flex;justify-content:center;align-items:center;height:100vh;margin:0;color:var(--ink);
    }
    #chatbox{
      width:430px;height:640px;background:var(--card);border-radius:22px;box-shadow:var(--shadow);
      display:flex;flex-direction:column;overflow:hidden;position:relative;animation:fadeIn .5s ease;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* header */
    #header{background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;font-weight:700}
    #left{display:flex;align-items:center;gap:10px}
    #mascot-img{
      width:34px;height:34px;border-radius:50%;
      box-shadow:0 2px 4px rgba(0,0,0,.2);
      transition:opacity .4s ease;
    }
    #mascot-img.fade-out { opacity: 0; }

    #header .meta{display:flex;gap:6px}
    #header .chip{font-size:12px;background:rgba(255,255,255,.25);padding:4px 8px;border-radius:8px}
    #header .actions{display:flex;gap:8px}
    #header button{background:rgba(255,255,255,.25);border:none;color:#fff;border-radius:9px;padding:6px 10px;
      font-size:12px;cursor:pointer;transition:.2s}
    #header button:hover{background:rgba(255,255,255,.45)}

    /* messages */
    #messages{flex:1;overflow-y:auto;padding:14px 14px 6px;display:flex;flex-direction:column}
    .message{display:flex;align-items:flex-start;margin:8px 0}
    .bot{flex-direction:row}.user{flex-direction:row-reverse}
    .pf{width:40px;height:40px;border-radius:50%;margin:0 8px;box-shadow:0 2px 4px rgba(0,0,0,.12)}
    .bubble{max-width:72%;padding:10px 14px;border-radius:14px;line-height:1.5;word-break:break-word}
    .bot .bubble{background:var(--bubble-bot)} .user .bubble{background:var(--bubble-user)}

    /* input */
    #input-area{display:flex;gap:8px;border-top:1px solid #e6eef7;padding:10px;background:#fafcff}
    #upload-btn{background:transparent;border:none;font-size:20px;cursor:pointer}
    #upload-btn:hover{color:var(--blue-2)}
    #input{flex:1;border:none;border-radius:20px;padding:10px 14px;background:var(--muted);outline:none}
    #send-btn{width:42px;height:42px;border-radius:50%;border:none;background:var(--blue-2);color:#fff;cursor:pointer}
    #send-btn:hover{filter:brightness(.95)}

    /* small helper pills */
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef6ff;
      font-size:12px;color:#446}
  </style>
</head>
<body>
  <div id="chatbox">
    <div id="header">
      <div id="left">
        <!-- ‚úÖ Î¥á(ÎÅºÎ¶¨) ÌîÑÎ°úÌïÑ: ÏÑúÎ≤Ñ ÏÑ∏ÏÖò/DBÏóêÏÑú Í∞ÄÏ†∏Ïò¥ -->
        <img id="mascot-img"
             src="{{ url_for('static', filename='mascot/' + (session.get('mascot') or current_user.mascot or 'mascot00.png')) }}"
             alt="ÎÅºÎ¶¨">
        <div>ÎÅºÎ¶¨ Ï±óÎ¥á üí¨</div>
      </div>
      <div class="meta">
        <span id="clock" class="chip">--:--</span>
        <span id="wx" class="chip">ÎÇ†Ïî® Î∂àÎü¨Ïò§Îäî Ï§ë</span>
      </div>
      <div class="actions">
        <button onclick="location.href='/analyze'">Î¶¨Ìè¨Ìä∏</button>
        <button onclick="resetChat()">ÏÉàÎ°úÍ≥†Ïπ®</button>
        <!-- ‚úÖ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ï¶à: Ï†ÑÏö© ÌéòÏù¥ÏßÄ ÏÇ¨Ïö© -->
        <button onclick="location.href='/customize'">Íæ∏ÎØ∏Í∏∞</button>
      </div>
    </div>

    <div id="messages"></div>

    <div id="input-area">
      <button id="upload-btn" title="ÌååÏùº Î≥¥ÎÇ¥Í∏∞">üìé</button>
      <input type="file" id="image-input" accept="image/*" hidden>
      <input type="text" id="input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." autocomplete="off">
      <button id="send-btn">‚û§</button>
    </div>
  </div>

  <script>
    // ===== ÏÉÅÌÉú =====
    const historyFromServer = {{ history|tojson|default("[]") }};
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send-btn");
    const uploadBtn = document.getElementById("upload-btn");
    const fileInput = document.getElementById("image-input");

    // ‚úÖ ÎÇ¥ ÏïÑÎ∞îÌÉÄ (Î°úÏª¨ Ï†ÄÏû•)
    const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
    let userAvatar = localStorage.getItem("userAvatar") || DEFAULT_AVATAR;

    // ‚úÖ ÎÅºÎ¶¨(Î¥á) ÎßàÏä§ÏΩîÌä∏ (ÏÑúÎ≤Ñ/ÏÑ∏ÏÖò ‚Üí local fallback)
    const mascotImgEl = document.getElementById("mascot-img");
    let botMascot = localStorage.getItem("kirriMascot") ||
      "{{ url_for('static', filename='mascot/' + (session.get('mascot') or current_user.mascot or 'mascot00.png')) }}";
    mascotImgEl.src = botMascot;

    // ===== Î©îÏãúÏßÄ Î†åÎçîÎßÅ =====
    function addMessage(role, text){
      const row = document.createElement("div");
      row.className = `message ${role}`;
      const pf = document.createElement("img");
      pf.className = "pf";
      pf.src = role === "bot" ? botMascot : userAvatar;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      row.append(pf, bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Ï¥àÍ∏∞ Î°úÎìú
    if (historyFromServer.length){
      historyFromServer.forEach(m => addMessage(m.role === "assistant" ? "bot" : m.role, m.message));
    } else {
      addMessage("bot", "ÏïàÎÖï! ÎÇú ÎÅºÎ¶¨Ïïº. Ïò§Îäò Ïª®ÎîîÏÖò Ïñ¥Îïå?");
    }

    // Ï†ÑÏÜ°
    sendBtn.addEventListener("click", send);
    inputEl.addEventListener("keydown", e => { if (e.key === "Enter") send(); });
    function send(){
      const text = inputEl.value.trim();
      if (!text) return;
      addMessage("user", text);
      inputEl.value = "";
      const fd = new FormData();
      fd.append("message", text);
      fetch("/chat", { method:"POST", body:fd })
        .then(r => r.json())
        .then(d => addMessage("bot", d.response))
        .catch(console.error);
    }

    // ÌååÏùº Ï†ÑÏÜ°(ÏòµÏÖò: ÏÑúÎ≤ÑÍ∞Ä ÏßÄÏõêÌïòÎ©¥ ÏÇ¨Ïö©)
    uploadBtn.onclick = () => fileInput.click();

    // ÏÉàÎ°úÍ≥†Ïπ®(ÏÑúÎ≤Ñ Î°úÍ∑∏ ÏÇ≠Ï†ú + ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî)
    async function resetChat(){
      if (!confirm("Ï†ïÎßê ÎåÄÌôîÎ•º Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?")) return;
      await fetch("/reset", { method:"POST", credentials:"include" });
      location.reload();
    }

    // ÏãúÍ≥Ñ/ÎÇ†Ïî®
    function tick(){
      const now = new Date();
      const hh = now.getHours().toString().padStart(2,"0");
      const mm = now.getMinutes().toString().padStart(2,"0");
      document.getElementById("clock").textContent = `${hh}:${mm}`;
    }
    setInterval(tick, 1000); tick();

    (async function weather(){
      try{
        const r = await fetch("https://wttr.in/Seoul?format=%C+%t");
        const t = await r.text();
        let emoji="‚òÅÔ∏è";
        if (t.includes("Îßë")||t.includes("Sunny")) emoji="‚òÄÔ∏è";
        else if (t.includes("ÎπÑ")||t.includes("Rain")) emoji="üåß";
        else if (t.includes("Îàà")||t.includes("Snow")) emoji="‚ùÑÔ∏è";
        document.getElementById("wx").textContent = `${emoji} ${t}`;
      }catch(e){
        document.getElementById("wx").textContent = "‚òÅÔ∏è ÎÇ†Ïî® Ïò§Î•ò";
      }
    })();

    // ‚úÖ ÎßàÏä§ÏΩîÌä∏ ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ (localStorage Î≥ÄÍ≤Ω Í∞êÏßÄ)
    window.addEventListener("storage", (e) => {
      if (e.key === "kirriMascot") {
        const newMascot = e.newValue;
        if (newMascot && newMascot !== botMascot) {
          mascotImgEl.classList.add("fade-out");
          setTimeout(() => {
            botMascot = newMascot;
            mascotImgEl.src = newMascot;
            mascotImgEl.classList.remove("fade-out");
          }, 300);
        }
      }
      if (e.key === "userAvatar") {
        userAvatar = e.newValue || DEFAULT_AVATAR;
      }
    });
  </script>
</body>
</html>
