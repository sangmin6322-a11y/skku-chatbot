<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¨ ë¼ë¦¬ ê¾¸ë¯¸ê¸°</title>
  <style>
    :root {
      --bg: #eaf6ff;
      --blue: #58aafc;
      --card: #fff;
      --shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    body {
      background: var(--bg);
      font-family: "Noto Sans KR", sans-serif;
      text-align: center;
      margin: 0;
      padding: 30px 0;
    }
    h2 { color: #333; margin-bottom: 10px; }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      background: #d6eaff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    .tab-btn.active { background: var(--blue); color: white; }

    .content { display: none; }
    .content.active { display: block; animation: fade .3s ease; }
    @keyframes fade {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .preview {
      background: var(--card);
      width: 220px; height: 220px;
      margin: 0 auto 25px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }
    .preview img {
      width: 200px; height: auto;
      transition: opacity 0.4s ease;
    }

    /* --- [ìƒˆ ìŠ¤íƒ€ì¼] ì¹´í…Œê³ ë¦¬ --- */
    .category-group {
      text-align: left;
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.5);
    }
    .category-title {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
      margin-left: 5px;
      margin-bottom: 10px;
    }
    /* --- [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë³µì›] ì´ëª¨ì§€ ë²„íŠ¼ --- */
    .emoji-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .emoji-btn {
      font-size: 1.8em;
      background: #fff;
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: .2s;
    }
    .emoji-btn:hover {
      transform: scale(1.1);
      border-color: var(--blue);
    }
    .emoji-btn.selected {
      background: #e3f3ff;
      border: 3px solid var(--blue);
    }
    /* --- [ìŠ¤íƒ€ì¼ ë] --- */

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 20px;
      justify-items: center;
      margin-top: 20px;
    }

    .option {
      width: 110px;
      border-radius: 20px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 10px;
      transition: transform .2s, border .2s;
    }
    .option:hover { transform: scale(1.07); }
    .selected { border: 3px solid var(--blue); background: #e9f6ff; }

    .option img {
      width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
    }
    .option button {
      margin-top: 10px; border: none; background: none;
      font-size: 1.6em; cursor: pointer; transition: .2s;
    }
    .option button:hover { transform: scale(1.2); }

    .btns {
      display: flex; justify-content: center; gap: 12px; margin-top: 20px;
    }
    button.action {
      background: var(--blue);
      border: none; color: white; font-weight: 600;
      border-radius: 10px; padding: 10px 20px;
      cursor: pointer; transition: .2s;
    }
    button.action:hover { filter: brightness(0.95); }
  </style>
</head>
<body>
  <h2>ğŸ¨ ë¼ë¦¬ ê¾¸ë¯¸ê¸°</h2>

  <!-- âœ… íƒ­ ë²„íŠ¼ -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('avatar')">ì•„ë°”íƒ€ ğŸ‘¤</button>
    <button class="tab-btn" onclick="switchTab('mascot')">ë§ˆìŠ¤ì½”íŠ¸ ğŸ¤–</button>
  </div>

  <!-- âœ… ì•„ë°”íƒ€ ê¾¸ë¯¸ê¸° (ê¸°ì¡´ê³¼ ë™ì¼) -->
  <div id="avatar" class="content active">
    <div class="preview">
      <img id="avatar-preview" src="{{ url_for('static', filename='avatars/ava1.png') }}" alt="ì•„ë°”íƒ€"
           onerror="this.src='https://placehold.co/200x200/fff/9ca3af?text=Avatar';">
    </div>
    <p>ë‚´ í”„ë¡œí•„ ì•„ë°”íƒ€ë¥¼ ê³¨ë¼ë´ ğŸ‘‡</p>
    <div class="grid">
      {% set avas = ["ava1.png","ava2.png","ava3.png","ava4.png"] %}
      {% set emojis = ["ğŸ˜€","ğŸ˜","ğŸ§¸","ğŸ§‘â€ğŸ“"] %}
      {% for a in avas %}
      <div class="option">
        <img src="{{ url_for('static', filename='avatars/' + a) }}" alt="{{ a }}"
             onerror="this.src='https://placehold.co/90x90/f3f4f6/9ca3af?text=Img';">
        <button onclick="selectAvatar('{{ url_for('static', filename='avatars/' + a) }}', this)">
          {{ emojis[loop.index0] }}
        </button>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- âœ… ë§ˆìŠ¤ì½”íŠ¸ ê¾¸ë¯¸ê¸° ([ìˆ˜ì •ë¨]) -->
  <div id="mascot" class="content">
    <div class="preview">
      <img id="kirri-preview" 
           src="{{ url_for('static', filename='mascot/' + (current_user.mascot or 'mascot00.png')) }}" 
           alt="ë¼ë¦¬"
           onerror="this.src='https://placehold.co/200x200/fff/3b82f6?text=KKIRI';">
    </div>
    <p>ë¼ë¦¬ì˜ ì˜·ì„ ê³¨ë¼ì¤˜ ğŸ’•</p>

    <!-- [ìˆ˜ì •ë¨] 2ë‹¨ ì¹´í…Œê³ ë¦¬ UI (ì´ëª¨ì§€ ë²„ì „) -->
    <div class="categories-container" style="max-width: 400px; margin: 0 auto;">
      
      <!-- ì¹´í…Œê³ ë¦¬ 1: acc -->
      <div class="category-group">
        <div class="category-title">acc</div>
        <div class="emoji-bar">
          {% for mascot_file, emoji in acc_data %}
            <button class="emoji-btn {% if current_user.mascot == mascot_file %}selected{% endif %}"
                    onclick="selectOutfit('{{ mascot_file }}', this)">
              {{ emoji }}
            </button>
          {% endfor %}
        </div>
      </div>

      <!-- [ìˆ˜ì •ë¨] ì¹´í…Œê³ ë¦¬ 2: clothes (object ì¹´í…Œê³ ë¦¬ ì‚­ì œ) -->
      <div class="category-group">
        <div class="category-title">clothes</div>
        <div class="emoji-bar">
          {% for mascot_file, emoji in clothes_data %}
            <button class="emoji-btn {% if current_user.mascot == mascot_file %}selected{% endif %}"
                    onclick="selectOutfit('{{ mascot_file }}', this)">
              {{ emoji }}
            </button>
          {% endfor %}
        </div>
      </div>
      
    </div>
    <!-- [ìˆ˜ì • ë] -->

    <div class="btns">
      <form id="saveForm" method="POST" style="display:inline;">
        <input type="hidden" name="mascot" id="selectedMascot" value="{{ current_user.mascot or 'mascot00.png' }}">
        <button type="submit" class.action="action">ì €ì¥í•˜ê¸° ğŸ’¾</button>
      </form>
      <button class="action" onclick="location.href='/'">ëŒì•„ê°€ê¸° â¬…</button>
    </div>
  </div>

  <script>
    // âœ… íƒ­ ì „í™˜ (ê¸°ì¡´ê³¼ ë™ì¼)
    function switchTab(tab) {
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".content").forEach(c=>c.classList.remove("active"));
      document.querySelector(`.tab-btn[onclick*='${tab}']`).classList.add("active");
      document.getElementById(tab).classList.add("active");
    }

    // âœ… ì•„ë°”íƒ€ ì„ íƒ (ê¸°ì¡´ê³¼ ë™ì¼)
    const avatarPreview = document.getElementById("avatar-preview");
    function selectAvatar(path, el){
      localStorage.setItem("userAvatar", path);
      avatarPreview.style.opacity=0;
      setTimeout(()=>{ avatarPreview.src = path; avatarPreview.style.opacity=1; }, 300);
      document.querySelectorAll("#avatar .option").forEach(o=>o.classList.remove("selected"));
      el.parentElement.classList.add("selected");
      alert("ë‚´ ì•„ë°”íƒ€ê°€ ë°”ë€Œì—ˆì–´! ğŸ¨ ì±„íŒ…ì°½ì—ë„ ì ìš©ë¼!");
    }
     // í˜ì´ì§€ ë¡œë“œ ì‹œ localStorageì—ì„œ ì•„ë°”íƒ€ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', () => {
        const savedAvatar = localStorage.getItem("userAvatar");
        if(savedAvatar) {
            avatarPreview.src = savedAvatar;
        }
    });

    // âœ… ë§ˆìŠ¤ì½”íŠ¸ ì„ íƒ (ê¸°ì¡´ê³¼ ë™ì¼, ë²„íŠ¼ í´ë˜ìŠ¤ .emoji-btn)
    const preview = document.getElementById("kirri-preview");
    const hiddenInput = document.getElementById("selectedMascot");
    const buttons = document.querySelectorAll(".emoji-btn");
    let selectedFile = "{{ current_user.mascot or 'mascot00.png' }}";

    function selectOutfit(file, el){
      buttons.forEach(b=>b.classList.remove("selected"));
      el.classList.add("selected");
      selectedFile = file;
      hiddenInput.value = file;
      preview.style.opacity = 0;
      setTimeout(()=>{
        // [ìˆ˜ì •] ê²½ë¡œì— /mascot/ ì¶”ê°€
        preview.src = `{{ url_for('static', filename='mascot/') }}${file}`;
        preview.style.opacity = 1;
      }, 300);
    }

    // âœ… ì €ì¥ (ì„œë²„ + localStorage) ([ìˆ˜ì •ë¨], fetch ì‘ë‹µ ì²˜ë¦¬)
    document.getElementById("saveForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const file = hiddenInput.value || selectedFile;
      if (!file) return alert("ë¨¼ì € ì˜·ì„ ê³¨ë¼ì¤˜!");
      
      // [ìˆ˜ì •] ê²½ë¡œì— /mascot/ ì¶”ê°€
      localStorage.setItem("kirriMascot", `{{ url_for('static', filename='mascot/') }}${file}`);
      
      const formData = new FormData();
      formData.append("mascot", file);
      
      fetch("{{ url_for('customize') }}", { 
          method:"POST", 
          body:formData 
      })
      .then(response => response.json()) // JSON ì‘ë‹µì„ ë°›ìŒ
      .then(data => {
          if(data.success) {
              alert("ğŸ’¾ ë¼ë¦¬ ì˜· ì €ì¥ ì™„ë£Œ!");
          } else {
              alert("âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + data.message);
          }
      })
      .catch((error) => {
          console.error("Error:", error);
          alert("âš ï¸ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    });
  </script>
</body>
</html>