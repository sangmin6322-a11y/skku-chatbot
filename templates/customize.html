<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¨ ë¼ë¦¬ ì˜· ê°ˆì•„ì…íˆê¸°</title>
  <style>
    :root {
      --bg: #eaf6ff;
      --blue: #58aafc;
      --card: #fff;
      --shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    body {
      background: var(--bg);
      font-family: "Noto Sans KR", sans-serif;
      text-align: center;
      margin: 0;
      padding: 30px 0;
    }
    h2 { color: #333; margin-bottom: 10px; }
    .preview {
      background: var(--card);
      width: 220px; height: 220px;
      margin: 0 auto 25px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }
    .preview img {
      width: 200px; height: auto;
      transition: opacity 0.4s ease;
    }
    .emoji-bar {
      display: flex; justify-content: center; gap: 12px;
      flex-wrap: wrap; margin-bottom: 30px;
    }
    .emoji-btn {
      font-size: 1.8em; background: #fff;
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 8px 12px; cursor: pointer;
      box-shadow: var(--shadow);
      transition: .2s;
    }
    .emoji-btn:hover {
      transform: scale(1.15);
      border-color: var(--blue);
    }
    .emoji-btn.selected {
      background: #e3f3ff;
      border: 3px solid var(--blue);
    }
    .btns {
      display: flex; justify-content: center; gap: 12px;
    }
    button.action {
      background: var(--blue);
      border: none; color: white;
      font-weight: 600;
      border-radius: 10px;
      padding: 10px 20px;
      cursor: pointer; transition: .2s;
    }
    button.action:hover { filter: brightness(0.95); }
  </style>
</head>
<body>
  <h2>ğŸ¨ ë¼ë¦¬ ê¾¸ë¯¸ê¸°</h2>
  <p>ë§ˆìŒì— ë“œëŠ” ì˜·ì„ ê³¨ë¼ë´ ğŸ’•</p>

  <!-- âœ… í”„ë¦¬ë·° ì˜ì—­ -->
  <div class="preview">
    <img id="kirri-preview" src="{{ url_for('static', filename='mascot/' + (current_user.mascot or 'mascot00.png')) }}" alt="ë¼ë¦¬">
  </div>

  <!-- âœ… ì˜· ì•„ì´í…œ ì´ëª¨ì§€ -->
  <div class="emoji-bar">
    {% set emojis = ["ğŸ€","ğŸ‰","ğŸŒŸ","ğŸ§¢","ğŸ‘’","ğŸ•¶","ğŸŒ¿","ğŸµ"] %}
    {% for i in range(8) %}
      <button class="emoji-btn {% if current_user.mascot == ('mascot0' ~ i ~ '.png') %}selected{% endif %}"
              onclick="selectOutfit('mascot0{{ i }}.png', this)">
        {{ emojis[i] }}
      </button>
    {% endfor %}
  </div>

  <!-- âœ… ì €ì¥/ëŒì•„ê°€ê¸° -->
  <div class="btns">
    <form id="saveForm" method="POST" style="display:inline;">
      <input type="hidden" name="mascot" id="selectedMascot">
      <button type="submit" class="action">ì €ì¥í•˜ê¸° ğŸ’¾</button>
    </form>
    <button class="action" onclick="goBack()">ëŒì•„ê°€ê¸° â¬…</button>
  </div>

  <script>
    const preview = document.getElementById("kirri-preview");
    const hiddenInput = document.getElementById("selectedMascot");
    const buttons = document.querySelectorAll(".emoji-btn");

    let selectedFile = "{{ current_user.mascot or 'mascot00.png' }}";

    // âœ… ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ë³€ê²½
    function selectOutfit(file, el) {
      buttons.forEach(b => b.classList.remove("selected"));
      el.classList.add("selected");
      selectedFile = file;
      hiddenInput.value = file;
      preview.style.opacity = 0;
      setTimeout(() => {
        preview.src = `/static/mascot/${file}`;
        preview.style.opacity = 1;
      }, 300);
    }

    // âœ… ì €ì¥ í›„ ë¡œì»¬ì—ë„ ì €ì¥ (index ì—°ë™)
    document.getElementById("saveForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const file = hiddenInput.value || selectedFile;
      if (!file) return alert("ë¨¼ì € ë§ˆìŠ¤ì½”íŠ¸ë¥¼ ì„ íƒí•´ì¤˜!");

      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
      localStorage.setItem("kirriMascot", `/static/mascot/${file}`);

      // ì„œë²„ì— ì „ì†¡
      const formData = new FormData();
      formData.append("mascot", file);
      fetch("/customize", { method: "POST", body: formData })
        .then(() => {
          alert("ğŸ’¾ ì €ì¥ ì™„ë£Œ! ë¼ë¦¬ê°€ ìƒˆ ì˜·ì„ ì…ì—ˆì–´!");
        })
        .catch(() => alert("âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"));
    });

    // âœ… ëŒì•„ê°€ê¸° ë²„íŠ¼
    function goBack() {
      // index.htmlì—ì„œ ìë™ ë°˜ì˜ë˜ë„ë¡ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‹ í˜¸ ìœ ì§€
      window.location.href = "/";
    }
  </script>
</body>
</html>
