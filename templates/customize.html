<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¨ ë¼ë¦¬ ê¾¸ë¯¸ê¸°</title>
  <style>
    :root {
      --bg: #eaf6ff;
      --blue: #58aafc;
      --card: #fff;
      --shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    body {
      background: var(--bg);
      font-family: "Noto Sans KR", sans-serif;
      text-align: center;
      margin: 0;
      padding: 30px 0;
    }
    h2 { color: #333; margin-bottom: 10px; }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      background: #d6eaff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    .tab-btn.active { background: var(--blue); color: white; }

    .content { display: none; }
    .content.active { display: block; animation: fade .3s ease; }
    @keyframes fade {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .preview {
      background: var(--card);
      width: 220px; height: 220px;
      margin: 0 auto 25px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }
    .preview img {
      width: 200px; height: auto;
      transition: opacity 0.4s ease;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 20px;
      justify-items: center;
      margin-top: 20px;
    }

    .option {
      width: 110px;
      border-radius: 20px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 10px;
      transition: transform .2s, border .2s;
    }
    .option:hover { transform: scale(1.07); }
    .selected { border: 3px solid var(--blue); background: #e9f6ff; }

    .option img {
      width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
    }
    .option button {
      margin-top: 10px; border: none; background: none;
      font-size: 1.6em; cursor: pointer; transition: .2s;
    }
    .option button:hover { transform: scale(1.2); }

    .emoji-bar {
      display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
      margin-bottom: 30px;
    }
    .emoji-btn {
      font-size: 1.8em; background: #fff;
      border: 2px solid transparent; border-radius: 10px;
      padding: 8px 12px; cursor: pointer;
      box-shadow: var(--shadow); transition: .2s;
    }
    .emoji-btn:hover { transform: scale(1.15); border-color: var(--blue); }
    .emoji-btn.selected { background: #e3f3ff; border: 3px solid var(--blue); }

    .btns {
      display: flex; justify-content: center; gap: 12px; margin-top: 20px;
    }
    button.action {
      background: var(--blue);
      border: none; color: white; font-weight: 600;
      border-radius: 10px; padding: 10px 20px;
      cursor: pointer; transition: .2s;
    }
    button.action:hover { filter: brightness(0.95); }
  </style>
</head>
<body>
  <h2>ğŸ¨ ë¼ë¦¬ ê¾¸ë¯¸ê¸°</h2>

  <!-- âœ… íƒ­ ë²„íŠ¼ -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('avatar')">ì•„ë°”íƒ€ ğŸ‘¤</button>
    <button class="tab-btn" onclick="switchTab('mascot')">ë§ˆìŠ¤ì½”íŠ¸ ğŸ¤–</button>
  </div>

  <!-- âœ… ì•„ë°”íƒ€ ê¾¸ë¯¸ê¸° -->
  <div id="avatar" class="content active">
    <div class="preview">
      <img id="avatar-preview" src="{{ url_for('static', filename='avatars/ava1.jpg') }}" alt="ì•„ë°”íƒ€">
    </div>
    <p>ë‚´ í”„ë¡œí•„ ì•„ë°”íƒ€ë¥¼ ê³¨ë¼ë´ ğŸ‘‡</p>
    <div class="grid">
      {% set avas = ["ava1.png","ava2.png","ava3.png","ava4.png"] %}
      {% set emojis = ["ğŸ˜€","ğŸ˜","ğŸ§¸","ğŸ§‘â€ğŸ“"] %}
      {% for a in avas %}
      <div class="option">
        <img src="{{ url_for('static', filename='avatars/' + a) }}" alt="{{ a }}">
        <button onclick="selectAvatar('{{ url_for('static', filename='avatars/' + a) }}', this)">
          {{ emojis[loop.index0] }}
        </button>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- âœ… ë§ˆìŠ¤ì½”íŠ¸ ê¾¸ë¯¸ê¸° -->
  <div id="mascot" class="content">
    <div class="preview">
      <img id="kirri-preview" src="{{ url_for('static', filename='mascot/' + (current_user.mascot or 'mascot00.png')) }}" alt="ë¼ë¦¬">
    </div>
    <p>ë¼ë¦¬ì˜ ì˜·ì„ ê³¨ë¼ì¤˜ ğŸ’•</p>
    <div class="emoji-bar">
      {% set emojis = ["ğŸ€","ğŸ‰","ğŸŒŸ","ğŸ§¢","ğŸ‘’","ğŸ•¶","ğŸŒ¿","ğŸµ"] %}
      {% for i in range(8) %}
        <button class="emoji-btn {% if current_user.mascot == ('mascot0' ~ i ~ '.png') %}selected{% endif %}"
                onclick="selectOutfit('mascot0{{ i }}.png', this)">
          {{ emojis[i] }}
        </button>
      {% endfor %}
    </div>
    <div class="btns">
      <form id="saveForm" method="POST" style="display:inline;">
        <input type="hidden" name="mascot" id="selectedMascot">
        <button type="submit" class="action">ì €ì¥í•˜ê¸° ğŸ’¾</button>
      </form>
      <button class="action" onclick="location.href='/'">ëŒì•„ê°€ê¸° â¬…</button>
    </div>
  </div>

  <script>
    // âœ… íƒ­ ì „í™˜
    function switchTab(tab) {
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".content").forEach(c=>c.classList.remove("active"));
      document.querySelector(`.tab-btn[onclick*='${tab}']`).classList.add("active");
      document.getElementById(tab).classList.add("active");
    }

    // âœ… ì•„ë°”íƒ€ ì„ íƒ
    const avatarPreview = document.getElementById("avatar-preview");
    function selectAvatar(path, el){
      localStorage.setItem("userAvatar", path);
      avatarPreview.style.opacity=0;
      setTimeout(()=>{ avatarPreview.src = path; avatarPreview.style.opacity=1; }, 300);
      document.querySelectorAll("#avatar .option").forEach(o=>o.classList.remove("selected"));
      el.parentElement.classList.add("selected");
      alert("ë‚´ ì•„ë°”íƒ€ê°€ ë°”ë€Œì—ˆì–´! ğŸ¨ ì±„íŒ…ì°½ì—ë„ ì ìš©ë¼!");
    }

    // âœ… ë§ˆìŠ¤ì½”íŠ¸ ì„ íƒ
    const preview = document.getElementById("kirri-preview");
    const hiddenInput = document.getElementById("selectedMascot");
    const buttons = document.querySelectorAll(".emoji-btn");
    let selectedFile = "{{ current_user.mascot or 'mascot00.png' }}";

    function selectOutfit(file, el){
      buttons.forEach(b=>b.classList.remove("selected"));
      el.classList.add("selected");
      selectedFile = file;
      hiddenInput.value = file;
      preview.style.opacity = 0;
      setTimeout(()=>{
        preview.src = `/static/mascot/${file}`;
        preview.style.opacity = 1;
      }, 300);
    }

    // âœ… ì €ì¥ (ì„œë²„ + localStorage)
    document.getElementById("saveForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const file = hiddenInput.value || selectedFile;
      if (!file) return alert("ë¨¼ì € ì˜·ì„ ê³¨ë¼ì¤˜!");
      localStorage.setItem("kirriMascot", `/static/mascot/${file}`);
      const formData = new FormData();
      formData.append("mascot", file);
      fetch("/customize", { method:"POST", body:formData })
        .then(()=>alert("ğŸ’¾ ë¼ë¦¬ ì˜· ì €ì¥ ì™„ë£Œ!"))
        .catch(()=>alert("âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"));
    });
  </script>
</body>
</html>
